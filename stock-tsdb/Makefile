# è‚¡ç¥¨è¡Œæƒ…æ•°æ®TSDBç³»ç»Ÿ Makefile
# åŸºäº LuaJIT çš„è½»é‡çº§æ—¶é—´åºåˆ—æ•°æ®åº“

# åŸºç¡€é…ç½®
PROJECT_NAME = stock-tsdb
VERSION = 1.0.0
LUAROCKS = luarocks

# ç›®å½•é…ç½®
SRC_DIR = src
OBJ_DIR = obj
BIN_DIR = bin
CONF_DIR = conf
LUA_DIR = lua
LIB_DIR = lib
LOGS_DIR = logs
DATA_DIR = data

# Lua ç›¸å…³é…ç½®
LUA_VERSION = 5.1
LUAJIT_BIN = luajit

# ç³»ç»Ÿæ£€æµ‹
UNAME_S := $(shell uname -s)
ifeq ($(UNAME_S),Linux)
    PLATFORM = linux
endif
ifeq ($(UNAME_S),Darwin)
    PLATFORM = macos
endif

# Lua æ¨¡å—åˆ—è¡¨
LUA_MODULES = $(LUA_DIR)/tsdb.lua \
               $(LUA_DIR)/storage.lua \
               $(LUA_DIR)/api.lua \
               $(LUA_DIR)/cluster.lua \
               $(LUA_DIR)/config.lua \
               $(LUA_DIR)/logger.lua \
               $(LUA_DIR)/monitor.lua \
               $(LUA_DIR)/main.lua \
               $(LUA_DIR)/event_server.lua

# ç›®æ ‡æ–‡ä»¶
TARGET = $(BIN_DIR)/stock-tsdb-server
MAIN_SCRIPT = stock-tsdb
MICRO_TS_SO = $(LIB_DIR)/micro_ts.so

# é»˜è®¤ç›®æ ‡
.PHONY: all build install clean test help check-deps install-deps run-dev run-prod

all: check-deps build

# ä¾èµ–æ£€æŸ¥
check-deps:
	@echo "æ£€æŸ¥ç³»ç»Ÿä¾èµ–..."
	@which $(LUAJIT_BIN) > /dev/null || (echo "é”™è¯¯: æœªæ‰¾åˆ° LuaJITï¼Œè¯·å…ˆå®‰è£…" && exit 1)
	@which $(LUAROCKS) > /dev/null || (echo "é”™è¯¯: æœªæ‰¾åˆ° LuaRocksï¼Œè¯·å…ˆå®‰è£…" && exit 1)
	@echo "âœ“ ç³»ç»Ÿä¾èµ–æ£€æŸ¥é€šè¿‡"

# åˆ›å»ºç›®å½•
$(BIN_DIR) $(LIB_DIR) $(LOGS_DIR) $(DATA_DIR):
	@mkdir -p $@

# æ„å»ºé¡¹ç›®
build: directories $(TARGET) $(MICRO_TS_SO)
	@echo "æ„å»ºå®Œæˆ âœ“"

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
$(TARGET): $(BIN_DIR)
	@echo "åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬..."
	@echo '#!/bin/bash' > $@
	@echo 'export LUA_PATH="$$LUA_PATH;./lua/?.lua;$(PREFIX)/share/$(PROJECT_NAME)/lua/?.lua;$$HOME/.luarocks/share/lua/5.1/?.lua;$$HOME/.luarocks/share/lua/5.1/?/init.lua"' >> $@
	@echo 'export LUA_CPATH="$$LUA_CPATH;./lib/?.so;./lib/?.dylib;$(PREFIX)/lib/lua/$(LUA_VERSION)/?.so;$$HOME/.luarocks/lib/lua/5.1/?.so;../lib/?.so"' >> $@
	@echo 'exec $(LUAJIT_BIN) $(MAIN_SCRIPT) "$$@"' >> $@
	@chmod +x $@
	@echo "âœ“ å¯åŠ¨å™¨è„šæœ¬å·²åˆ›å»º"

# ç¼–è¯‘ micro_ts.so
$(MICRO_TS_SO): $(LIB_DIR) $(SRC_DIR)/micro_ts.c
	@echo "ç¼–è¯‘ micro_ts.so..."
	@gcc -O2 -fPIC -shared -I/usr/local/include/luajit-2.1 $(SRC_DIR)/micro_ts.c -o $@
	@echo "âœ“ micro_ts.so ç¼–è¯‘å®Œæˆ"

# å®‰è£… Lua ä¾èµ–
install-deps: directories
	@echo "å®‰è£… Lua ä¾èµ–åŒ…..."
	@echo "æ£€æŸ¥æœ¬åœ°ä¾èµ–..."
	@if [ -f $(LIB_DIR)/cjson.so ]; then \
		echo "âœ“ cjson å·²å­˜åœ¨äº lib ç›®å½•"; \
	else \
		echo "è­¦å‘Š: æœªæ‰¾åˆ°æœ¬åœ° cjson.so æ–‡ä»¶"; \
		echo "è¯·è¿è¡Œ 'make install-cjson' å®‰è£… lua-cjson åº“"; \
	fi
	@if [ -f $(LIB_DIR)/micro_ts.so ]; then \
		echo "âœ“ micro_ts å·²å­˜åœ¨äº lib ç›®å½•"; \
	else \
		echo "æç¤º: æœªæ‰¾åˆ°æœ¬åœ° micro_ts.so æ–‡ä»¶"; \
		echo "è¯·è¿è¡Œ 'make build' ç¼–è¯‘ micro_ts åº“"; \
	fi
	@echo "âœ“ Lua ä¾èµ–å®‰è£…å®Œæˆ"

# å®‰è£… lua-cjson åº“
install-cjson: directories
	@echo "å®‰è£… lua-cjson åº“..."
	@echo "ä½¿ç”¨ luarocks å®‰è£… lua-cjson..."
	@sudo luarocks install lua-cjson LUA_INCDIR=/usr/local/include/luajit-2.1 LUA_LIBDIR=/usr/local/lib/
	@echo "æŸ¥æ‰¾å¹¶æ‹·è´ cjson.so åˆ° lib ç›®å½•..."
	@if [ -f /usr/local/lib/lua/5.1/cjson.so ]; then \
		cp /usr/local/lib/lua/5.1/cjson.so $(LIB_DIR)/ && echo "âœ“ ä» /usr/local/lib/lua/5.1/ æ‹·è´æˆåŠŸ"; \
	elif [ -f /usr/local/lib/lua/5.2/cjson.so ]; then \
		cp /usr/local/lib/lua/5.2/cjson.so $(LIB_DIR)/ && echo "âœ“ ä» /usr/local/lib/lua/5.2/ æ‹·è´æˆåŠŸ"; \
	elif [ -f /usr/local/lib/luarocks/rocks/lua-cjson/*/lib/cjson.so ]; then \
		cp /usr/local/lib/luarocks/rocks/lua-cjson/*/lib/cjson.so $(LIB_DIR)/ && echo "âœ“ ä» luarocks ç›®å½•æ‹·è´æˆåŠŸ"; \
	else \
		echo "è­¦å‘Š: æ— æ³•è‡ªåŠ¨æ‰¾åˆ° cjson.soï¼Œè¯·æ‰‹åŠ¨æŸ¥æ‰¾å¹¶æ‹·è´åˆ° $(LIB_DIR)/ ç›®å½•"; \
		echo "å¯èƒ½çš„è·¯å¾„:"; \
		echo "  - /usr/local/lib/lua/5.1/cjson.so"; \
		echo "  - /usr/local/lib/lua/5.2/cjson.so"; \
		echo "  - /usr/local/lib/luarocks/rocks/lua-cjson/*/lib/cjson.so"; \
		echo "  - /usr/lib/lua/5.1/cjson.so"; \
	fi
	@echo "âœ“ lua-cjson å®‰è£…å®Œæˆ"

# ç¼–è¯‘ micro_ts åº“
build-micro-ts: directories $(MICRO_TS_SO)
	@echo "âœ“ micro_ts åº“ç¼–è¯‘å®Œæˆ"

# è¿è¡Œæµ‹è¯•
test: build
	@echo "è¿è¡Œæµ‹è¯•..."
	@if [ -f tests/run_tests.sh ]; then \
		cd tests && ./run_tests.sh; \
	else \
		echo "è¿è¡Œ Lua æµ‹è¯•..."; \
		LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) tests/simple_test.lua; \
	fi
	@echo ""
	@echo "è¿è¡Œé…ç½®ç®¡ç†å™¨æµ‹è¯•..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) examples/testing/test_config_manager.lua
	@echo "âœ“ æµ‹è¯•å®Œæˆ"

# è¿è¡Œé…ç½®ç®¡ç†å™¨æµ‹è¯•
test-config-manager: build
	@echo "è¿è¡Œé…ç½®ç®¡ç†å™¨æµ‹è¯•..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) examples/testing/test_config_manager.lua
	@echo "âœ“ é…ç½®ç®¡ç†å™¨æµ‹è¯•å®Œæˆ"

# è¿è¡Œé…ç½®ç®¡ç†å™¨å¿«é€Ÿæµ‹è¯•
test-config-manager-quick: build
	@echo "è¿è¡Œé…ç½®ç®¡ç†å™¨å¿«é€Ÿæµ‹è¯•..."
	@$(LUAJIT_BIN) -e "
		package.path = package.path .. ';./lua/?.lua;./?.lua;;'
		package.cpath = package.cpath .. ';./lib/?.so;;'
		
		local ConfigManager = require 'config_manager'
		local config_manager = ConfigManager:new('./data/config_db')
		local success, err = config_manager:initialize()
		if success then
			print('âœ“ é…ç½®ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ')
			
			-- æµ‹è¯•è·å–ç³»ç»Ÿé…ç½®
			local system_config = config_manager:get_config('system', 'main')
			if system_config and system_config.server then
				print('âœ“ ç³»ç»Ÿé…ç½®è·å–æˆåŠŸ')
				print('   ç«¯å£:', system_config.server.port)
				print('   ç»‘å®šåœ°å€:', system_config.server.bind)
			else
				print('âœ— ç³»ç»Ÿé…ç½®è·å–å¤±è´¥')
			end
			
			-- æµ‹è¯•è·å–ä¸šåŠ¡é…ç½®
			local business_configs = config_manager:get_all_business_configs()
			if business_configs then
				print('âœ“ ä¸šåŠ¡é…ç½®è·å–æˆåŠŸï¼Œå…±', #business_configs, 'ä¸ªä¸šåŠ¡ç±»å‹')
			else
				print('âœ— ä¸šåŠ¡é…ç½®è·å–å¤±è´¥')
			end
			
			config_manager:close()
			print('âœ“ é…ç½®ç®¡ç†å™¨å…³é—­æˆåŠŸ')
		else
			print('âœ— é…ç½®ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥:', err)
		end
	"
	@echo "âœ“ é…ç½®ç®¡ç†å™¨å¿«é€Ÿæµ‹è¯•å®Œæˆ"

# å…ƒæ•°æ®åˆå§‹åŒ–
metadata-init: build
	@echo "åˆå§‹åŒ–å…ƒæ•°æ®é…ç½®..."
	@$(LUAJIT_BIN) -e '\
	package.path = package.path .. ";./lua/?.lua;./?.lua;;"; \
	package.cpath = package.cpath .. ";./lib/?.so;;"; \
	local ConfigManager = require "config_manager"; \
	local config_manager = ConfigManager:new("./data/config_db"); \
	local success, err = config_manager:initialize(); \
	if success then \
		print("âœ“ é…ç½®ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ"); \
		local version_meta = config_manager:get_config("metadata", "version"); \
		if version_meta then \
			print("âœ“ ç‰ˆæœ¬å…ƒæ•°æ®:"); \
			print("   é…ç½®ç‰ˆæœ¬:", version_meta.config_schema_version); \
			print("   æœ€åæ›´æ–°:", version_meta.last_updated); \
			print("   åˆ›å»ºè€…:", version_meta.created_by); \
		else \
			print("âœ— ç‰ˆæœ¬å…ƒæ•°æ®è·å–å¤±è´¥"); \
		end; \
		local stats_meta = config_manager:get_config("metadata", "statistics"); \
		if stats_meta then \
			print("âœ“ ç»Ÿè®¡å…ƒæ•°æ®:"); \
			print("   ä¸šåŠ¡ç±»å‹æ•°é‡:", stats_meta.total_business_types); \
			print("   å®ä¾‹æ•°é‡:", stats_meta.total_instances); \
			print("   é…ç½®é¡¹æ•°é‡:", stats_meta.config_items_count); \
		else \
			print("âœ— ç»Ÿè®¡å…ƒæ•°æ®è·å–å¤±è´¥"); \
		end; \
		config_manager:close(); \
		print("âœ“ å…ƒæ•°æ®åˆå§‹åŒ–å®Œæˆ"); \
	else \
		print("âœ— é…ç½®ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥:", err); \
	end'
	@echo "âœ“ å…ƒæ•°æ®åˆå§‹åŒ–å®Œæˆ"

# æŸ¥è¯¢å…ƒæ•°æ®åˆ—è¡¨
metadata-list: build
	@echo "æŸ¥è¯¢å…ƒæ•°æ®åˆ—è¡¨..."
	@$(LUAJIT_BIN) -e '\
	package.path = package.path .. ";./lua/?.lua;./?.lua;;"; \
	package.cpath = package.cpath .. ";./lib/?.so;;"; \
	local ConfigManager = require "config_manager"; \
	local config_manager = ConfigManager:new("./data/config_db"); \
	local success, err = config_manager:initialize(); \
	if success then \
		print("âœ“ é…ç½®ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ"); \
		local metadata_types = {"version", "statistics"}; \
		print("âœ“ å…ƒæ•°æ®ç±»å‹åˆ—è¡¨:"); \
		for i, meta_type in ipairs(metadata_types) do \
			print("   " .. i .. ". " .. meta_type); \
		end; \
		print("âœ“ å…ƒæ•°æ®å†…å®¹:"); \
		for i, meta_type in ipairs(metadata_types) do \
			local meta_data = config_manager:get_config("metadata", meta_type); \
			if meta_data then \
				print("   " .. meta_type .. ":"); \
				for key, value in pairs(meta_data) do \
					print("      " .. key .. ": " .. tostring(value)); \
				end; \
			else \
				print("   " .. meta_type .. ": æ— æ•°æ®"); \
			end; \
		end; \
		print("âœ“ é…ç½®ç»Ÿè®¡:"); \
		print("   å…ƒæ•°æ®ç±»å‹æ•°é‡:", #metadata_types); \
		config_manager:close(); \
		print("âœ“ å…ƒæ•°æ®æŸ¥è¯¢å®Œæˆ"); \
	else \
		print("âœ— é…ç½®ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥:", err); \
	end'
	@echo "âœ“ å…ƒæ•°æ®åˆ—è¡¨æŸ¥è¯¢å®Œæˆ"

# å…ƒæ•°æ®ä¿®æ”¹
metadata-update: build
	@echo "ä¿®æ”¹å…ƒæ•°æ®é…ç½®..."
	@$(LUAJIT_BIN) -e '\
	package.path = package.path .. ";./lua/?.lua;./?.lua;;"; \
	package.cpath = package.cpath .. ";./lib/?.so;;"; \
	local ConfigManager = require "config_manager"; \
	local config_manager = ConfigManager:new("./data/config_db"); \
	local success, err = config_manager:initialize(); \
	if success then \
		print("âœ“ é…ç½®ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ"); \
		local new_version_meta = { \
			config_schema_version = "1.1", \
			last_updated = os.date("%Y-%m-%d %H:%M:%S"), \
			created_by = "metadata-update command" \
		}; \
		local update_success = config_manager:update_config("metadata", "version", new_version_meta); \
		if update_success then \
			print("âœ“ ç‰ˆæœ¬å…ƒæ•°æ®æ›´æ–°æˆåŠŸ"); \
			print("   æ–°ç‰ˆæœ¬:", new_version_meta.config_schema_version); \
			print("   æ›´æ–°æ—¶é—´:", new_version_meta.last_updated); \
		else \
			print("âœ— ç‰ˆæœ¬å…ƒæ•°æ®æ›´æ–°å¤±è´¥"); \
		end; \
		local new_stats_meta = { \
			total_business_types = 5, \
			total_instances = 15, \
			config_items_count = 42 \
		}; \
		update_success = config_manager:update_config("metadata", "statistics", new_stats_meta); \
		if update_success then \
			print("âœ“ ç»Ÿè®¡å…ƒæ•°æ®æ›´æ–°æˆåŠŸ"); \
			print("   ä¸šåŠ¡ç±»å‹æ•°é‡:", new_stats_meta.total_business_types); \
			print("   å®ä¾‹æ•°é‡:", new_stats_meta.total_instances); \
			print("   é…ç½®é¡¹æ•°é‡:", new_stats_meta.config_items_count); \
		else \
			print("âœ— ç»Ÿè®¡å…ƒæ•°æ®æ›´æ–°å¤±è´¥"); \
		end; \
		config_manager:close(); \
		print("âœ“ å…ƒæ•°æ®æ›´æ–°å®Œæˆ"); \
	else \
		print("âœ— é…ç½®ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥:", err); \
	end'
	@echo "âœ“ å…ƒæ•°æ®ä¿®æ”¹å®Œæˆ"

# è¿è¡Œæ ¸å¿ƒæµ‹è¯•ï¼ˆè·³è¿‡ä¸ç¨³å®šçš„æµ‹è¯•ï¼‰
test-core: build
	@echo "è¿è¡Œæ ¸å¿ƒæµ‹è¯•..."
	@cd tests && LUA_PATH='../lua/?.lua;../?.lua;../examples/?.lua;../examples/?/?.lua;;' $(LUAJIT_BIN) run_core_tests.lua
	@echo "âœ“ æ ¸å¿ƒæµ‹è¯•å®Œæˆ"

# V3ç‰ˆæœ¬æµ‹è¯•ç›®æ ‡
test-v3: build
	@echo "è¿è¡ŒV3ç‰ˆæœ¬æµ‹è¯•..."
	@echo "1. è¿è¡ŒV3åŸºç¡€ç‰ˆæœ¬æµ‹è¯•..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) examples/v3/test_v3_basic.lua
	@echo "2. è¿è¡ŒV3é›†æˆç‰ˆæœ¬æµ‹è¯•..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) examples/v3/test_v3_integrated.lua
	@echo "3. è¿è¡ŒV3ç‰ˆæœ¬å¯¹æ¯”æµ‹è¯•..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) examples/v3/test_v3_comparison.lua
	@echo "4. è¿è¡ŒV3ç‰ˆæœ¬åŠŸèƒ½éªŒè¯..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) examples/v3/test_v3_validation.lua
	@echo "âœ“ V3ç‰ˆæœ¬æµ‹è¯•å®Œæˆ"

# V3åŸºç¡€ç‰ˆæœ¬æµ‹è¯•
test-v3-basic: build
	@echo "è¿è¡ŒV3åŸºç¡€ç‰ˆæœ¬æµ‹è¯•..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) examples/v3/test_v3_basic.lua
	@echo "âœ“ V3åŸºç¡€ç‰ˆæœ¬æµ‹è¯•å®Œæˆ"

# V3é›†æˆç‰ˆæœ¬æµ‹è¯•
test-v3-integrated: build
	@echo "è¿è¡ŒV3é›†æˆç‰ˆæœ¬æµ‹è¯•..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) examples/v3/test_v3_integrated.lua
	@echo "âœ“ V3é›†æˆç‰ˆæœ¬æµ‹è¯•å®Œæˆ"

# V3ç‰ˆæœ¬å¯¹æ¯”æµ‹è¯•
test-v3-comparison: build
	@echo "è¿è¡ŒV3ç‰ˆæœ¬å¯¹æ¯”æµ‹è¯•..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) examples/v3/test_v3_comparison.lua
	@echo "âœ“ V3ç‰ˆæœ¬å¯¹æ¯”æµ‹è¯•å®Œæˆ"

# V3ç‰ˆæœ¬åŠŸèƒ½éªŒè¯
test-v3-validation: build
	@echo "è¿è¡ŒV3ç‰ˆæœ¬åŠŸèƒ½éªŒè¯..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) examples/v3/test_v3_validation.lua
	@echo "âœ“ V3ç‰ˆæœ¬åŠŸèƒ½éªŒè¯å®Œæˆ"

# V3æ€§èƒ½è¯¦ç»†åˆ†æ
test-v3-performance: build
	@echo "è¿è¡ŒV3æ€§èƒ½è¯¦ç»†åˆ†æ..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) examples/v3/v3_performance_analysis_final.lua
	@echo "âœ“ V3æ€§èƒ½è¯¦ç»†åˆ†æå®Œæˆ"

# V3æœ€ç»ˆå¯¹æ¯”æµ‹è¯•
test-v3-final: build
	@echo "è¿è¡ŒV3æœ€ç»ˆå¯¹æ¯”æµ‹è¯•..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) examples/v3/test_v3_final_comparison.lua
	@echo "âœ“ V3æœ€ç»ˆå¯¹æ¯”æµ‹è¯•å®Œæˆ"

# è¿è¡Œæ‰€æœ‰é›†ç¾¤æµ‹è¯•
test-cluster: build
	@echo "è¿è¡Œæ‰€æœ‰é›†ç¾¤æµ‹è¯•..."
	@echo "1. è¿è¡Œç®€å•é›†ç¾¤æµ‹è¯•..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) tests/simple_cluster_test.lua
	@echo "2. è¿è¡ŒTSDBé›†ç¾¤æµ‹è¯•..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) tests/tsdb_cluster_test.lua
	@echo "3. è¿è¡Œä¸šåŠ¡é›†ç¾¤æµ‹è¯•..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) test_business_cluster.lua
	@echo "4. è¿è¡ŒConsulé›†æˆæµ‹è¯•..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) test_consul_integration.lua
	@echo "5. è¿è¡Œä¼˜åŒ–é›†ç¾¤æµ‹è¯•..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) test_optimized_cluster.lua
	@echo "âœ“ æ‰€æœ‰é›†ç¾¤æµ‹è¯•å®Œæˆ"

# è¿è¡Œç®€å•é›†ç¾¤æµ‹è¯•
test-cluster-simple: build
	@echo "è¿è¡Œç®€å•é›†ç¾¤æµ‹è¯•..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) tests/simple_cluster_test.lua
	@echo "âœ“ ç®€å•é›†ç¾¤æµ‹è¯•å®Œæˆ"

# è¿è¡ŒTSDBé›†ç¾¤æµ‹è¯•
test-cluster-tsdb: build
	@echo "è¿è¡ŒTSDBé›†ç¾¤æµ‹è¯•..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) tests/tsdb_cluster_test.lua
	@echo "âœ“ TSDBé›†ç¾¤æµ‹è¯•å®Œæˆ"

# è¿è¡Œä¸šåŠ¡é›†ç¾¤æµ‹è¯•
test-cluster-business: build
	@echo "è¿è¡Œä¸šåŠ¡é›†ç¾¤æµ‹è¯•..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) test_business_cluster.lua
	@echo "âœ“ ä¸šåŠ¡é›†ç¾¤æµ‹è¯•å®Œæˆ"

# è¿è¡ŒConsulé›†æˆæµ‹è¯•
test-cluster-consul: build
	@echo "è¿è¡ŒConsulé›†æˆæµ‹è¯•..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) test_consul_integration.lua
	@echo "âœ“ Consulé›†æˆæµ‹è¯•å®Œæˆ"

# è¿è¡Œä¼˜åŒ–é›†ç¾¤æµ‹è¯•
test-cluster-optimized: build
	@echo "è¿è¡Œä¼˜åŒ–é›†ç¾¤æµ‹è¯•..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) test_optimized_cluster.lua
	@echo "âœ“ ä¼˜åŒ–é›†ç¾¤æµ‹è¯•å®Œæˆ"

# è¿è¡Œæ‰€æœ‰é›†ç¾¤ç›¸å…³æµ‹è¯•ï¼ˆåŒ…æ‹¬é›†æˆæµ‹è¯•ï¼‰
test-cluster-all: build
	@echo "è¿è¡Œæ‰€æœ‰é›†ç¾¤ç›¸å…³æµ‹è¯•..."
	@echo "1. è¿è¡Œç®€å•é›†ç¾¤æµ‹è¯•..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) tests/simple_cluster_test.lua
	@echo "2. è¿è¡ŒTSDBé›†ç¾¤æµ‹è¯•..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) tests/tsdb_cluster_test.lua
	@echo "3. è¿è¡Œä¸šåŠ¡é›†ç¾¤æµ‹è¯•..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) test_business_cluster.lua
	@echo "4. è¿è¡ŒConsulé›†æˆæµ‹è¯•..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) test_consul_integration.lua
	@echo "5. è¿è¡Œä¼˜åŒ–é›†ç¾¤æµ‹è¯•..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) test_optimized_cluster.lua
	@echo "6. è¿è¡Œé›†æˆTSDBæµ‹è¯•..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) tests/integrated_tsdb_test.lua || echo "æ³¨æ„: é›†æˆTSDBæµ‹è¯•å¯èƒ½æœ‰ä¾èµ–é—®é¢˜"
	@echo "7. è¿è¡ŒçœŸå®è‚¡ç¥¨æ•°æ®æµ‹è¯•..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) tests/real_stock_data_test.lua || echo "æ³¨æ„: çœŸå®è‚¡ç¥¨æ•°æ®æµ‹è¯•å¯èƒ½æœ‰ä¾èµ–é—®é¢˜"
	@echo "8. è¿è¡Œç»¼åˆæµ‹è¯•..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) tests/comprehensive_test.lua || echo "æ³¨æ„: ç»¼åˆæµ‹è¯•å¯èƒ½æœ‰ä¾èµ–é—®é¢˜"
	@echo "9. è¿è¡Œè‚¡ç¥¨ç¤ºä¾‹æµ‹è¯•..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) tests/stock_example.lua
	@echo "10. è¿è¡ŒRedisé›†ç¾¤æµ‹è¯•..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) tests/test_redis_cluster.lua || echo "æ³¨æ„: Redisé›†ç¾¤æµ‹è¯•å¯èƒ½æœ‰ä¾èµ–é—®é¢˜"
	@echo "11. è¿è¡ŒFFIæµ‹è¯•..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) tests/test_ffi.lua
	@echo "12. è¿è¡Œå†·çƒ­æ•°æ®åŠŸèƒ½æµ‹è¯•..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) test_daily_cf_engine.lua
	@echo "13. è¿è¡Œå†·çƒ­æ•°æ®é›†æˆç¤ºä¾‹..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) integrate_daily_cf_example.lua
	@echo "âœ“ æ‰€æœ‰é›†ç¾¤ç›¸å…³æµ‹è¯•å®Œæˆ"

# å†·çƒ­æ•°æ®åŠŸèƒ½ä¸“é¡¹æµ‹è¯•
test-cold-hot-data: build
	@echo "è¿è¡Œå†·çƒ­æ•°æ®åŠŸèƒ½ä¸“é¡¹æµ‹è¯•..."
	@echo "1. æµ‹è¯•æ¯æ—¥CFå­˜å‚¨å¼•æ“..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) test_daily_cf_engine.lua
	@echo "2. æµ‹è¯•å†·çƒ­æ•°æ®é›†æˆç¤ºä¾‹..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) integrate_daily_cf_example.lua
	@echo "3. æµ‹è¯•å†·çƒ­æ•°æ®åœ¨é›†ç¾¤ä¸­çš„åº”ç”¨..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) test_cold_hot_cluster.lua || echo "æ³¨æ„: å†·çƒ­æ•°æ®é›†ç¾¤æµ‹è¯•å¯èƒ½æœ‰ä¾èµ–é—®é¢˜"
	@echo "âœ“ å†·çƒ­æ•°æ®åŠŸèƒ½ä¸“é¡¹æµ‹è¯•å®Œæˆ"

# å¿«é€ŸéªŒè¯ï¼ˆæ¨èç”¨äºå¼€å‘ï¼‰
test-quick: build
	@echo "è¿è¡Œå¿«é€ŸéªŒè¯æµ‹è¯•..."
	@echo "1. V3åŸºç¡€ç‰ˆæœ¬åŠŸèƒ½éªŒè¯..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) examples/v3/test_v3_validation.lua
	@echo "2. V3ç‰ˆæœ¬å¯¹æ¯”æµ‹è¯•..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) examples/v3/test_v3_comparison.lua
	@echo "3. ç®€å•é›†ç¾¤æµ‹è¯•..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) tests/simple_cluster_test.lua
	@echo "âœ“ å¿«é€ŸéªŒè¯å®Œæˆ"

# ç³»ç»Ÿå¥åº·æ£€æŸ¥
health-check:
	@echo "ç³»ç»Ÿå¥åº·æ£€æŸ¥..."
	@echo "1. æ£€æŸ¥LuaJIT..."
	@which $(LUAJIT_BIN) > /dev/null && echo "âœ“ LuaJITå¯ç”¨" || echo "âœ— LuaJITæœªæ‰¾åˆ°"
	@echo "2. æ£€æŸ¥LuaRocks..."
	@which $(LUAROCKS) > /dev/null && echo "âœ“ LuaRockså¯ç”¨" || echo "âœ— LuaRocksæœªæ‰¾åˆ°"
	@echo "3. æ£€æŸ¥æ ¸å¿ƒæ–‡ä»¶..."
	@which $(LUAJIT_BIN) > /dev/null && echo "âœ“ LuaJITå¯æ‰§è¡Œ" || echo "âœ— LuaJITä¸å¯æ‰§è¡Œ"
	@test -f examples/v3/test_v3_basic.lua && echo "âœ“ V3åŸºç¡€æµ‹è¯•æ–‡ä»¶å­˜åœ¨" || echo "âœ— V3åŸºç¡€æµ‹è¯•æ–‡ä»¶ç¼ºå¤±"
	@test -f examples/v3/test_v3_validation.lua && echo "âœ“ V3éªŒè¯æµ‹è¯•æ–‡ä»¶å­˜åœ¨" || echo "âœ— V3éªŒè¯æµ‹è¯•æ–‡ä»¶ç¼ºå¤±"
	@test -d lua && echo "âœ“ Luaæ¨¡å—ç›®å½•å­˜åœ¨" || echo "âœ— Luaæ¨¡å—ç›®å½•ç¼ºå¤±"
	@test -d lib && echo "âœ“ åº“æ–‡ä»¶ç›®å½•å­˜åœ¨" || echo "âœ— åº“æ–‡ä»¶ç›®å½•ç¼ºå¤±"
	@echo "4. æ£€æŸ¥æ•°æ®ç›®å½•..."
	@test -d data && echo "âœ“ æ•°æ®ç›®å½•å­˜åœ¨" || echo "âœ— æ•°æ®ç›®å½•ç¼ºå¤±"
	@echo "âœ“ ç³»ç»Ÿå¥åº·æ£€æŸ¥å®Œæˆ"

# å¯åŠ¨Redisé›†ç¾¤æœåŠ¡å™¨
redis-server: build
	@echo "å¯åŠ¨Redisé›†ç¾¤æœåŠ¡å™¨..."
	@cd $(LUA_DIR) && LUA_PATH='./?.lua;../?.lua;;' $(LUAJIT_BIN) start_redis_cluster.lua

# å¯åŠ¨Redisé›†ç¾¤æœåŠ¡å™¨ï¼ˆåå°æ¨¡å¼ï¼‰
redis-server-daemon: build
	@echo "å¯åŠ¨Redisé›†ç¾¤æœåŠ¡å™¨ï¼ˆåå°æ¨¡å¼ï¼‰..."
	@cd $(LUA_DIR) && LUA_PATH='./?.lua;../?.lua;;' $(LUAJIT_BIN) start_redis_cluster.lua &
	@echo "Redisé›†ç¾¤æœåŠ¡å™¨å·²å¯åŠ¨ï¼ŒPID: $$!"

# æµ‹è¯•Redisé›†ç¾¤æœåŠ¡å™¨
redis-test: build
	@echo "æµ‹è¯•Redisé›†ç¾¤æœåŠ¡å™¨..."
	@echo "PINGå‘½ä»¤æµ‹è¯•..."
	@(echo "PING"; sleep 0.1) | nc 127.0.0.1 6379
	@echo ""
	@echo "INFOå‘½ä»¤æµ‹è¯•..."
	@(echo "INFO"; sleep 0.1) | nc 127.0.0.1 6379 | head -10
	@echo ""
	@echo "CLUSTER INFOå‘½ä»¤æµ‹è¯•..."
	@(echo "CLUSTER INFO"; sleep 0.1) | nc 127.0.0.1 6379
	@echo ""
	@echo "âœ“ Redisé›†ç¾¤æœåŠ¡å™¨æµ‹è¯•å®Œæˆ"

# è¿è¡ŒRedisé›†ç¾¤æœåŠ¡å™¨å®Œæ•´æµ‹è¯•
redis-test-full: build
	@echo "è¿è¡ŒRedisé›†ç¾¤æœåŠ¡å™¨å®Œæ•´æµ‹è¯•..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) tests/test_redis_cluster.lua

# åœæ­¢Redisé›†ç¾¤æœåŠ¡å™¨
redis-stop:
	@echo "åœæ­¢Redisé›†ç¾¤æœåŠ¡å™¨..."
	@pkill -f "start_redis_cluster.lua" || true
	@echo "âœ“ Redisé›†ç¾¤æœåŠ¡å™¨å·²åœæ­¢"

# Redis TCPæœåŠ¡å™¨ç›¸å…³å‘½ä»¤

# å¯åŠ¨Redis TCPæœåŠ¡å™¨
redis-tcp-server: build
	@echo "å¯åŠ¨Redis TCPæœåŠ¡å™¨..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) start_redis_tcp_server.lua

# å¯åŠ¨Redis TCPæœåŠ¡å™¨ï¼ˆåå°æ¨¡å¼ï¼‰
redis-tcp-server-daemon: build
	@echo "å¯åŠ¨Redis TCPæœåŠ¡å™¨ï¼ˆåå°æ¨¡å¼ï¼‰..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) start_redis_tcp_server.lua &
	@echo "Redis TCPæœåŠ¡å™¨å·²å¯åŠ¨ï¼ŒPID: $$!"

# WebæœåŠ¡å™¨ç›¸å…³å‘½ä»¤

# å¯åŠ¨å…ƒæ•°æ®WebæœåŠ¡å™¨
web-server: build
	@echo "å¯åŠ¨å…ƒæ•°æ®WebæœåŠ¡å™¨..."
	@cd web && LUA_PATH='../lua/?.lua;../?.lua;;' $(LUAJIT_BIN) start_metadata_web.lua

# å¯åŠ¨å…ƒæ•°æ®WebæœåŠ¡å™¨ï¼ˆåå°æ¨¡å¼ï¼‰
web-server-daemon: build
	@echo "å¯åŠ¨å…ƒæ•°æ®WebæœåŠ¡å™¨ï¼ˆåå°æ¨¡å¼ï¼‰..."
	@cd web && LUA_PATH='../lua/?.lua;../?.lua;;' $(LUAJIT_BIN) start_metadata_web.lua &
	@echo "å…ƒæ•°æ®WebæœåŠ¡å™¨å·²å¯åŠ¨ï¼ŒPID: $$!"

# æµ‹è¯•WebæœåŠ¡å™¨API
web-test: build
	@echo "æµ‹è¯•WebæœåŠ¡å™¨API..."
	@echo "1. æµ‹è¯•ä¸»é¡µ..."
	@curl -s -I http://localhost:8080 | head -1
	@echo "2. æµ‹è¯•é…ç½®API..."
	@curl -s http://localhost:8080/api/config | jq '.config_items_count' 2>/dev/null || echo "é…ç½®APIå“åº”:" && curl -s http://localhost:8080/api/config | head -2
	@echo "3. æµ‹è¯•å…ƒæ•°æ®API..."
	@curl -s http://localhost:8080/api/metadata | jq '.business_types | length' 2>/dev/null || echo "å…ƒæ•°æ®APIå“åº”:" && curl -s http://localhost:8080/api/metadata | head -2
	@echo "4. æµ‹è¯•é™æ€æ–‡ä»¶..."
	@curl -s -I http://localhost:8080/css/style.css | head -1
	@curl -s -I http://localhost:8080/js/app.js | head -1
	@echo "âœ“ WebæœåŠ¡å™¨APIæµ‹è¯•å®Œæˆ"

# WebæœåŠ¡å™¨å¿«é€Ÿæµ‹è¯•
web-test-quick: build
	@echo "WebæœåŠ¡å™¨å¿«é€Ÿæµ‹è¯•..."
	@echo "æµ‹è¯•ä¸»é¡µå“åº”..."
	@curl -s -I http://localhost:8080 | grep "HTTP" || echo "WebæœåŠ¡å™¨æœªè¿è¡Œ"
	@echo "æµ‹è¯•APIå“åº”..."
	@curl -s http://localhost:8080/api/config | head -1
	@echo "âœ“ WebæœåŠ¡å™¨å¿«é€Ÿæµ‹è¯•å®Œæˆ"

# åœæ­¢WebæœåŠ¡å™¨
web-stop:
	@echo "åœæ­¢WebæœåŠ¡å™¨..."
	@pkill -f "start_metadata_web.lua" || true
	@echo "âœ“ WebæœåŠ¡å™¨å·²åœæ­¢"

# WebæœåŠ¡å™¨å¥åº·æ£€æŸ¥
web-health: build
	@echo "WebæœåŠ¡å™¨å¥åº·æ£€æŸ¥..."
	@echo "1. æ£€æŸ¥WebæœåŠ¡å™¨è¿›ç¨‹..."
	@pgrep -f "start_metadata_web.lua" > /dev/null && echo "âœ“ WebæœåŠ¡å™¨è¿›ç¨‹è¿è¡Œä¸­" || echo "âœ— WebæœåŠ¡å™¨è¿›ç¨‹æœªè¿è¡Œ"
	@echo "2. æ£€æŸ¥ç«¯å£8080..."
	@netstat -an | grep 8080 > /dev/null && echo "âœ“ ç«¯å£8080è¢«å ç”¨" || echo "âœ— ç«¯å£8080æœªè¢«å ç”¨"
	@echo "3. æµ‹è¯•HTTPè¿æ¥..."
	@curl -s -m 5 http://localhost:8080 > /dev/null && echo "âœ“ HTTPè¿æ¥æ­£å¸¸" || echo "âœ— HTTPè¿æ¥å¤±è´¥"
	@echo "4. æµ‹è¯•APIç«¯ç‚¹..."
	@curl -s -m 5 http://localhost:8080/api/config > /dev/null && echo "âœ“ APIç«¯ç‚¹æ­£å¸¸" || echo "âœ— APIç«¯ç‚¹å¼‚å¸¸"
	@echo "âœ“ WebæœåŠ¡å™¨å¥åº·æ£€æŸ¥å®Œæˆ"

# å®Œæ•´çš„WebæœåŠ¡å™¨æµ‹è¯•å¥—ä»¶
web-test-full: build
	@echo "è¿è¡Œå®Œæ•´çš„WebæœåŠ¡å™¨æµ‹è¯•å¥—ä»¶..."
	@echo "1. å¯åŠ¨WebæœåŠ¡å™¨..."
	@cd web && LUA_PATH='../lua/?.lua;../?.lua;;' $(LUAJIT_BIN) start_metadata_web.lua &
	@WEB_PID=$$! && echo "WebæœåŠ¡å™¨å¯åŠ¨ï¼ŒPID: $$WEB_PID"
	@sleep 3
	@echo "2. è¿è¡Œå¥åº·æ£€æŸ¥..."
	@make web-health
	@echo "3. è¿è¡ŒAPIæµ‹è¯•..."
	@make web-test
	@echo "4. åœæ­¢WebæœåŠ¡å™¨..."
	@kill $$WEB_PID 2>/dev/null || true
	@echo "âœ“ å®Œæ•´çš„WebæœåŠ¡å™¨æµ‹è¯•å¥—ä»¶å®Œæˆ"

# å¼€å‘ç¯å¢ƒå¯åŠ¨ï¼ˆWebæœåŠ¡å™¨ + Redisé›†ç¾¤ï¼‰
dev-start: build
	@echo "å¯åŠ¨å¼€å‘ç¯å¢ƒ..."
	@echo "1. å¯åŠ¨Redisé›†ç¾¤æœåŠ¡å™¨..."
	@cd $(LUA_DIR) && LUA_PATH='./?.lua;../?.lua;;' $(LUAJIT_BIN) start_redis_cluster.lua &
	@REDIS_PID=$$! && echo "Redisé›†ç¾¤æœåŠ¡å™¨å¯åŠ¨ï¼ŒPID: $$REDIS_PID"
	@sleep 2
	@echo "2. å¯åŠ¨ä¸šåŠ¡æ•°æ®WebæœåŠ¡å™¨..."
	@cd web && LUA_PATH='../lua/?.lua;../?.lua;;' $(LUAJIT_BIN) start_business_web.lua &
	@WEB_PID=$$! && echo "ä¸šåŠ¡æ•°æ®WebæœåŠ¡å™¨å¯åŠ¨ï¼ŒPID: $$WEB_PID"
	@sleep 2
	@echo "3. å¯åŠ¨å…ƒæ•°æ®WebæœåŠ¡å™¨..."
	@cd web && LUA_PATH='../lua/?.lua;../?.lua;;' $(LUAJIT_BIN) start_metadata_web.lua &
	@METADATA_PID=$$! && echo "å…ƒæ•°æ®WebæœåŠ¡å™¨å¯åŠ¨ï¼ŒPID: $$METADATA_PID"
	@sleep 2
	@echo "âœ“ å¼€å‘ç¯å¢ƒå¯åŠ¨å®Œæˆ"
	@echo "æœåŠ¡ä¿¡æ¯:"
	@echo "  - Redisé›†ç¾¤æœåŠ¡å™¨: http://localhost:6379"
	@echo "  - ä¸šåŠ¡æ•°æ®WebæœåŠ¡å™¨: http://localhost:8081"
	@echo "  - å…ƒæ•°æ®WebæœåŠ¡å™¨: http://localhost:8080"
	@echo "ä½¿ç”¨ 'make dev-stop' åœæ­¢å¼€å‘ç¯å¢ƒ"

# åœæ­¢å¼€å‘ç¯å¢ƒ
dev-stop:
	@echo "åœæ­¢å¼€å‘ç¯å¢ƒ..."
	@pkill -f "start_redis_cluster.lua" || true
	@pkill -f "start_business_web.lua" || true
	@pkill -f "start_metadata_web.lua" || true
	@echo "âœ“ å¼€å‘ç¯å¢ƒå·²åœæ­¢"

# ä¸šåŠ¡æ•°æ®WebæœåŠ¡å™¨ç›¸å…³å‘½ä»¤

# å¯åŠ¨ä¸šåŠ¡æ•°æ®WebæœåŠ¡å™¨
business-web-server: build
	@echo "å¯åŠ¨ä¸šåŠ¡æ•°æ®WebæœåŠ¡å™¨..."
	@cd web && LUA_PATH='../lua/?.lua;../?.lua;;' $(LUAJIT_BIN) start_business_web.lua

# å¯åŠ¨ä¸šåŠ¡æ•°æ®WebæœåŠ¡å™¨ï¼ˆåå°æ¨¡å¼ï¼‰
business-web-server-daemon: build
	@echo "å¯åŠ¨ä¸šåŠ¡æ•°æ®WebæœåŠ¡å™¨ï¼ˆåå°æ¨¡å¼ï¼‰..."
	@cd web && LUA_PATH='../lua/?.lua;../?.lua;;' $(LUAJIT_BIN) start_business_web.lua &
	@echo "ä¸šåŠ¡æ•°æ®WebæœåŠ¡å™¨å·²å¯åŠ¨ï¼ŒPID: $$!"
	@echo "è®¿é—®åœ°å€: http://localhost:8081"

# æµ‹è¯•ä¸šåŠ¡æ•°æ®WebæœåŠ¡å™¨API
business-web-test: build
	@echo "æµ‹è¯•ä¸šåŠ¡æ•°æ®WebæœåŠ¡å™¨API..."
	@echo "1. æµ‹è¯•SQLæŸ¥è¯¢API..."
	@curl -s -X POST http://localhost:8081/business/query -H "Content-Type: application/json" -d '{"sql":"SELECT device_id, MAX(value), MIN(value), AVG(value) FROM iot_data GROUP BY device_id"}' | jq '.success' 2>/dev/null || echo "SQLæŸ¥è¯¢APIå“åº”:" && curl -s -X POST http://localhost:8081/business/query -H "Content-Type: application/json" -d '{"sql":"SELECT device_id, MAX(value), MIN(value), AVG(value) FROM iot_data GROUP BY device_id"}' | head -2
	@echo "2. æµ‹è¯•ä¸»é¡µ..."
	@curl -s -I http://localhost:8081 | head -1
	@echo "âœ“ ä¸šåŠ¡æ•°æ®WebæœåŠ¡å™¨APIæµ‹è¯•å®Œæˆ"

# åœæ­¢ä¸šåŠ¡æ•°æ®WebæœåŠ¡å™¨
business-web-stop:
	@echo "åœæ­¢ä¸šåŠ¡æ•°æ®WebæœåŠ¡å™¨..."
	@pkill -f "start_business_web.lua" || true
	@echo "âœ“ ä¸šåŠ¡æ•°æ®WebæœåŠ¡å™¨å·²åœæ­¢"

# ä¸šåŠ¡æ•°æ®WebæœåŠ¡å™¨å¥åº·æ£€æŸ¥
business-web-health: build
	@echo "ä¸šåŠ¡æ•°æ®WebæœåŠ¡å™¨å¥åº·æ£€æŸ¥..."
	@echo "1. æ£€æŸ¥WebæœåŠ¡å™¨è¿›ç¨‹..."
	@pgrep -f "start_business_web.lua" > /dev/null && echo "âœ“ ä¸šåŠ¡æ•°æ®WebæœåŠ¡å™¨è¿›ç¨‹è¿è¡Œä¸­" || echo "âœ— ä¸šåŠ¡æ•°æ®WebæœåŠ¡å™¨è¿›ç¨‹æœªè¿è¡Œ"
	@echo "2. æ£€æŸ¥ç«¯å£8081..."
	@netstat -an | grep 8081 > /dev/null && echo "âœ“ ç«¯å£8081è¢«å ç”¨" || echo "âœ— ç«¯å£8081æœªè¢«å ç”¨"
	@echo "3. æµ‹è¯•HTTPè¿æ¥..."
	@curl -s -m 5 http://localhost:8081 > /dev/null && echo "âœ“ HTTPè¿æ¥æ­£å¸¸" || echo "âœ— HTTPè¿æ¥å¤±è´¥"
	@echo "4. æµ‹è¯•SQLæŸ¥è¯¢ç«¯ç‚¹..."
	@curl -s -m 5 -X POST http://localhost:8081/business/query -H "Content-Type: application/json" -d '{"sql":"SELECT 1"}' > /dev/null && echo "âœ“ SQLæŸ¥è¯¢ç«¯ç‚¹æ­£å¸¸" || echo "âœ— SQLæŸ¥è¯¢ç«¯ç‚¹å¼‚å¸¸"
	@echo "âœ“ ä¸šåŠ¡æ•°æ®WebæœåŠ¡å™¨å¥åº·æ£€æŸ¥å®Œæˆ"

# å®Œæ•´çš„ä¸šåŠ¡æ•°æ®WebæœåŠ¡å™¨æµ‹è¯•å¥—ä»¶
business-web-test-full: build
	@echo "è¿è¡Œå®Œæ•´çš„ä¸šåŠ¡æ•°æ®WebæœåŠ¡å™¨æµ‹è¯•å¥—ä»¶..."
	@echo "1. å¯åŠ¨ä¸šåŠ¡æ•°æ®WebæœåŠ¡å™¨..."
	@cd web && LUA_PATH='../lua/?.lua;../?.lua;;' $(LUAJIT_BIN) start_business_web.lua &
	@BUSINESS_WEB_PID=$$! && echo "ä¸šåŠ¡æ•°æ®WebæœåŠ¡å™¨å¯åŠ¨ï¼ŒPID: $$BUSINESS_WEB_PID"
	@sleep 3
	@echo "2. è¿è¡Œå¥åº·æ£€æŸ¥..."
	@make business-web-health
	@echo "3. è¿è¡ŒAPIæµ‹è¯•..."
	@make business-web-test
	@echo "4. åœæ­¢ä¸šåŠ¡æ•°æ®WebæœåŠ¡å™¨..."
	@kill $$BUSINESS_WEB_PID 2>/dev/null || true
	@echo "âœ“ å®Œæ•´çš„ä¸šåŠ¡æ•°æ®WebæœåŠ¡å™¨æµ‹è¯•å¥—ä»¶å®Œæˆ"

# SQLæŸ¥è¯¢å­—æ®µé¡ºåºæµ‹è¯•
sql-field-order-test: build
	@echo "æµ‹è¯•SQLæŸ¥è¯¢å­—æ®µé¡ºåº..."
	@echo "1. å¯åŠ¨ä¸šåŠ¡æ•°æ®WebæœåŠ¡å™¨..."
	@cd web && LUA_PATH='../lua/?.lua;../?.lua;;' $(LUAJIT_BIN) start_business_web.lua &
	@BUSINESS_WEB_PID=$$! && echo "ä¸šåŠ¡æ•°æ®WebæœåŠ¡å™¨å¯åŠ¨ï¼ŒPID: $$BUSINESS_WEB_PID"
	@sleep 3
	@echo "2. æµ‹è¯•GROUP BYæŸ¥è¯¢å­—æ®µé¡ºåº..."
	@curl -s -X POST http://localhost:8081/business/query -H "Content-Type: application/json" -d '{"sql":"SELECT device_id, MAX(value), MIN(value), AVG(value) FROM iot_data GROUP BY device_id"}' | jq '.data[0] | keys' 2>/dev/null || echo "æŸ¥è¯¢ç»“æœ:" && curl -s -X POST http://localhost:8081/business/query -H "Content-Type: application/json" -d '{"sql":"SELECT device_id, MAX(value), MIN(value), AVG(value) FROM iot_data GROUP BY device_id"}' | head -5
	@echo "3. æµ‹è¯•è‚¡ç¥¨æ•°æ®æŸ¥è¯¢å­—æ®µé¡ºåº..."
	@curl -s -X POST http://localhost:8081/business/query -H "Content-Type: application/json" -d '{"sql":"SELECT stock_code, COUNT(*), AVG(price) FROM stock_quotes GROUP BY stock_code"}' | jq '.data[0] | keys' 2>/dev/null || echo "æŸ¥è¯¢ç»“æœ:" && curl -s -X POST http://localhost:8081/business/query -H "Content-Type: application/json" -d '{"sql":"SELECT stock_code, COUNT(*), AVG(price) FROM stock_quotes GROUP BY stock_code"}' | head -5
	@echo "4. åœæ­¢ä¸šåŠ¡æ•°æ®WebæœåŠ¡å™¨..."
	@kill $$BUSINESS_WEB_PID 2>/dev/null || true
	@echo "âœ“ SQLæŸ¥è¯¢å­—æ®µé¡ºåºæµ‹è¯•å®Œæˆ"

# å®Œæ•´çš„å¼€å‘ç¯å¢ƒæµ‹è¯•å¥—ä»¶
dev-test-full: build
	@echo "è¿è¡Œå®Œæ•´çš„å¼€å‘ç¯å¢ƒæµ‹è¯•å¥—ä»¶..."
	@echo "1. å¯åŠ¨å¼€å‘ç¯å¢ƒ..."
	@make dev-start
	@sleep 5
	@echo "2. è¿è¡ŒRedisé›†ç¾¤æµ‹è¯•..."
	@make redis-test
	@echo "3. è¿è¡Œå…ƒæ•°æ®WebæœåŠ¡å™¨æµ‹è¯•..."
	@make web-test
	@echo "4. è¿è¡Œä¸šåŠ¡æ•°æ®WebæœåŠ¡å™¨æµ‹è¯•..."
	@make business-web-test
	@echo "5. è¿è¡ŒSQLæŸ¥è¯¢å­—æ®µé¡ºåºæµ‹è¯•..."
	@make sql-field-order-test
	@echo "6. åœæ­¢å¼€å‘ç¯å¢ƒ..."
	@make dev-stop
	@echo "âœ“ å®Œæ•´çš„å¼€å‘ç¯å¢ƒæµ‹è¯•å¥—ä»¶å®Œæˆ"

# å¿«é€Ÿå¼€å‘æµ‹è¯•ï¼ˆæ¨èç”¨äºæ—¥å¸¸å¼€å‘ï¼‰
dev-test-quick: build
	@echo "è¿è¡Œå¿«é€Ÿå¼€å‘æµ‹è¯•..."
	@echo "1. å¯åŠ¨ä¸šåŠ¡æ•°æ®WebæœåŠ¡å™¨..."
	@cd web && LUA_PATH='../lua/?.lua;../?.lua;;' $(LUAJIT_BIN) start_business_web.lua &
	@BUSINESS_WEB_PID=$$! && echo "ä¸šåŠ¡æ•°æ®WebæœåŠ¡å™¨å¯åŠ¨ï¼ŒPID: $$BUSINESS_WEB_PID"
	@sleep 3
	@echo "2. æµ‹è¯•SQLæŸ¥è¯¢åŠŸèƒ½..."
	@curl -s -X POST http://localhost:8081/business/query -H "Content-Type: application/json" -d '{"sql":"SELECT device_id, MAX(value), MIN(value), AVG(value) FROM iot_data GROUP BY device_id"}' | jq '.success' 2>/dev/null && echo "âœ“ SQLæŸ¥è¯¢åŠŸèƒ½æ­£å¸¸" || echo "âœ— SQLæŸ¥è¯¢åŠŸèƒ½å¼‚å¸¸"
	@echo "3. åœæ­¢ä¸šåŠ¡æ•°æ®WebæœåŠ¡å™¨..."
	@kill $$BUSINESS_WEB_PID 2>/dev/null || true
	@echo "âœ“ å¿«é€Ÿå¼€å‘æµ‹è¯•å®Œæˆ"

# æ–‡æ¡£ç”Ÿæˆå’ŒéªŒè¯
docs-validate:
	@echo "éªŒè¯æ–‡æ¡£å®Œæ•´æ€§..."
	@test -f README.md && echo "âœ“ README.md å­˜åœ¨" || echo "âœ— README.md ç¼ºå¤±"
	@test -f CHANGELOG.md && echo "âœ“ CHANGELOG.md å­˜åœ¨" || echo "âœ— CHANGELOG.md ç¼ºå¤±"
	@test -f DOCUMENTATION_INDEX.md && echo "âœ“ DOCUMENTATION_INDEX.md å­˜åœ¨" || echo "âœ— DOCUMENTATION_INDEX.md ç¼ºå¤±"
	@test -f PROJECT_STRUCTURE.md && echo "âœ“ PROJECT_STRUCTURE.md å­˜åœ¨" || echo "âœ— PROJECT_STRUCTURE.md ç¼ºå¤±"
	@test -d docs && echo "âœ“ docsç›®å½•å­˜åœ¨" || echo "âœ— docsç›®å½•ç¼ºå¤±"
	@test -d scripts && echo "âœ“ scriptsç›®å½•å­˜åœ¨" || echo "âœ— scriptsç›®å½•ç¼ºå¤±"
	@echo "âœ“ æ–‡æ¡£éªŒè¯å®Œæˆ"

# è„šæœ¬éªŒè¯
scripts-validate:
	@echo "éªŒè¯è„šæœ¬å®Œæ•´æ€§..."
	@test -f scripts/install/install.sh && echo "âœ“ install.sh å­˜åœ¨" || echo "âœ— install.sh ç¼ºå¤±"
	@test -f scripts/install/production_deploy.sh && echo "âœ“ production_deploy.sh å­˜åœ¨" || echo "âœ— production_deploy.sh ç¼ºå¤±"
	@test -f scripts/install/monitor_production.sh && echo "âœ“ monitor_production.sh å­˜åœ¨" || echo "âœ— monitor_production.sh ç¼ºå¤±"
	@test -f scripts/install/backup_production.sh && echo "âœ“ backup_production.sh å­˜åœ¨" || echo "âœ— backup_production.sh ç¼ºå¤±"
	@test -f scripts/install/maintain_production.sh && echo "âœ“ maintain_production.sh å­˜åœ¨" || echo "âœ— maintain_production.sh ç¼ºå¤±"
	@echo "âœ“ è„šæœ¬éªŒè¯å®Œæˆ"

# é¡¹ç›®å®Œæ•´æ€§æ£€æŸ¥
project-integrity-check:
	@echo "é¡¹ç›®å®Œæ•´æ€§æ£€æŸ¥..."
	@make docs-validate
	@make scripts-validate
	@make health-check
	@echo "âœ“ é¡¹ç›®å®Œæ•´æ€§æ£€æŸ¥å®Œæˆ"

# é¡¹ç›®å®Œæ•´æ€§éªŒè¯ï¼ˆä½¿ç”¨è„šæœ¬ï¼‰
project-validate:
	@echo "=== é¡¹ç›®å®Œæ•´æ€§éªŒè¯ ==="
	@echo "ä½¿ç”¨éªŒè¯è„šæœ¬è¿›è¡Œå…¨é¢æ£€æŸ¥..."
	@chmod +x scripts/validate_project.sh
	@./scripts/validate_project.sh -c all -r
	@echo "éªŒè¯å®Œæˆï¼Œè¯¦ç»†æŠ¥å‘Šå·²ç”Ÿæˆã€‚"

# å¿«é€Ÿé¡¹ç›®éªŒè¯
project-validate-quick:
	@echo "=== å¿«é€Ÿé¡¹ç›®éªŒè¯ ==="
	@chmod +x scripts/validate_project.sh
	@./scripts/validate_project.sh -c files -c deps -c config

# é¡¹ç›®çŠ¶æ€æ£€æŸ¥
project-status:
	@echo "=== é¡¹ç›®çŠ¶æ€æ£€æŸ¥ ==="
	@chmod +x scripts/check_project_status.sh
	@./scripts/check_project_status.sh -c all

# å¼€å‘ç¯å¢ƒè®¾ç½®
dev-setup:
	@echo "=== å¼€å‘ç¯å¢ƒè®¾ç½® ==="
	@chmod +x scripts/setup_dev_env.sh
	@./scripts/setup_dev_env.sh -f

# å¼€å‘ç¯å¢ƒå¿«é€Ÿè®¾ç½®
dev-setup-quick:
	@echo "=== å¼€å‘ç¯å¢ƒå¿«é€Ÿè®¾ç½® ==="
	@chmod +x scripts/setup_dev_env.sh
	@./scripts/setup_dev_env.sh -b

# ä¸€é”®éƒ¨ç½²å’Œæµ‹è¯•ï¼ˆç”¨äºCI/CDï¼‰
ci-cd-pipeline: build
	@echo "è¿è¡ŒCI/CDæµæ°´çº¿..."
	@echo "1. é¡¹ç›®å®Œæ•´æ€§æ£€æŸ¥..."
	@make project-integrity-check
	@echo "2. è¿è¡Œæ ¸å¿ƒæµ‹è¯•..."
	@make test-core
	@echo "3. è¿è¡ŒV3ç‰ˆæœ¬æµ‹è¯•..."
	@make test-v3
	@echo "4. è¿è¡Œå¿«é€Ÿå¼€å‘æµ‹è¯•..."
	@make dev-test-quick
	@echo "âœ“ CI/CDæµæ°´çº¿å®Œæˆ"
	@sleep 2
	@echo "2. å¯åŠ¨å…ƒæ•°æ®WebæœåŠ¡å™¨..."
	@cd web && LUA_PATH='../lua/?.lua;../?.lua;;' $(LUAJIT_BIN) start_metadata_web.lua &
	@WEB_PID=$$! && echo "å…ƒæ•°æ®WebæœåŠ¡å™¨å¯åŠ¨ï¼ŒPID: $$WEB_PID"
	@sleep 2
	@echo "3. éªŒè¯æœåŠ¡çŠ¶æ€..."
	@echo "Redisé›†ç¾¤: http://localhost:6379"
	@echo "å…ƒæ•°æ®Web: http://localhost:8080"
	@echo "å¼€å‘ç¯å¢ƒå¯åŠ¨å®Œæˆï¼"
	@echo "ä½¿ç”¨ 'make dev-stop' åœæ­¢å¼€å‘ç¯å¢ƒ"

# åœæ­¢å¼€å‘ç¯å¢ƒ
dev-stop:
	@echo "åœæ­¢å¼€å‘ç¯å¢ƒ..."
	@make redis-stop
	@make web-stop
	@echo "âœ“ å¼€å‘ç¯å¢ƒå·²åœæ­¢"

# å¸®åŠ©ä¿¡æ¯
help:
	@echo "Stock-TSDB ç³»ç»Ÿç®¡ç†å‘½ä»¤"
	@echo ""
	@echo "åŸºæœ¬å‘½ä»¤:"
	@echo "  make build              - æ„å»ºé¡¹ç›®"
	@echo "  make test               - è¿è¡Œæµ‹è¯•"
	@echo "  make clean              - æ¸…ç†æ„å»ºæ–‡ä»¶"
	@echo "  make install-deps       - å®‰è£…ä¾èµ–"
	@echo ""
	@echo "WebæœåŠ¡å™¨å‘½ä»¤:"
	@echo "  make web-server          - å¯åŠ¨WebæœåŠ¡å™¨"
	@echo "  make web-server-daemon   - åå°å¯åŠ¨WebæœåŠ¡å™¨"
	@echo "  make web-test            - æµ‹è¯•WebæœåŠ¡å™¨API"
	@echo "  make web-health          - WebæœåŠ¡å™¨å¥åº·æ£€æŸ¥"
	@echo "  make web-stop            - åœæ­¢WebæœåŠ¡å™¨"
	@echo ""
	@echo "RedisæœåŠ¡å™¨å‘½ä»¤:"
	@echo "  make redis-server        - å¯åŠ¨Redisé›†ç¾¤æœåŠ¡å™¨"
	@echo "  make redis-server-daemon - åå°å¯åŠ¨Redisé›†ç¾¤æœåŠ¡å™¨"
	@echo "  make redis-test          - æµ‹è¯•Redisé›†ç¾¤æœåŠ¡å™¨"
	@echo "  make redis-stop          - åœæ­¢Redisé›†ç¾¤æœåŠ¡å™¨"
	@echo ""
	@echo "å¼€å‘ç¯å¢ƒå‘½ä»¤:"
	@echo "  make dev-start           - å¯åŠ¨å®Œæ•´å¼€å‘ç¯å¢ƒ"
	@echo "  make dev-stop            - åœæ­¢å¼€å‘ç¯å¢ƒ"
	@echo "  make dev-setup           - å®Œæ•´å¼€å‘ç¯å¢ƒè®¾ç½®"
	@echo "  make dev-setup-quick     - å¿«é€Ÿå¼€å‘ç¯å¢ƒè®¾ç½®"
	@echo ""
	@echo "é¡¹ç›®éªŒè¯å‘½ä»¤:"
	@echo "  make project-status      - é¡¹ç›®çŠ¶æ€æ£€æŸ¥"
	@echo "  make project-validate    - é¡¹ç›®å®Œæ•´æ€§éªŒè¯"
	@echo "  make project-validate-quick - å¿«é€Ÿé¡¹ç›®éªŒè¯"
	@echo "  make project-integrity-check - é¡¹ç›®å®Œæ•´æ€§æ£€æŸ¥"
	@echo ""
	@echo "æµ‹è¯•å‘½ä»¤:"
	@echo "  make test-core           - è¿è¡Œæ ¸å¿ƒæµ‹è¯•"
	@echo "  make test-v3             - è¿è¡ŒV3ç‰ˆæœ¬æµ‹è¯•"
	@echo "  make test-cluster        - è¿è¡Œé›†ç¾¤æµ‹è¯•"
	@echo "  make test-quick          - å¿«é€ŸéªŒè¯æµ‹è¯•"
	@echo ""
	@echo "æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹ README.md æ–‡ä»¶"

# æµ‹è¯•Redis TCPæœåŠ¡å™¨
redis-tcp-test: build
	@echo "æµ‹è¯•Redis TCPæœåŠ¡å™¨..."
	@echo "PINGå‘½ä»¤æµ‹è¯•..."
	@(echo "PING"; sleep 0.1) | nc 127.0.0.1 6379
	@echo ""
	@echo "ECHOå‘½ä»¤æµ‹è¯•..."
	@(echo "ECHO hello"; sleep 0.1) | nc 127.0.0.1 6379
	@echo ""
	@echo "TIMEå‘½ä»¤æµ‹è¯•..."
	@(echo "TIME"; sleep 0.1) | nc 127.0.0.1 6379
	@echo ""
	@echo "BATCH_SETå‘½ä»¤æµ‹è¯•..."
	@(echo "BATCH_SET test_key test_value"; sleep 0.1) | nc 127.0.0.1 6379
	@echo ""
	@echo "CLUSTER_INFOå‘½ä»¤æµ‹è¯•..."
	@(echo "CLUSTER INFO"; sleep 0.1) | nc 127.0.0.1 6379
	@echo ""
	@echo "âœ“ Redis TCPæœåŠ¡å™¨æµ‹è¯•å®Œæˆ"

# è¿è¡ŒRedis TCPæœåŠ¡å™¨å®Œæ•´æµ‹è¯•
redis-tcp-test-full: build
	@echo "è¿è¡ŒRedis TCPæœåŠ¡å™¨å®Œæ•´æµ‹è¯•..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) tests/test_redis_tcp_server.lua

# åœæ­¢Redis TCPæœåŠ¡å™¨
redis-tcp-stop:
	@echo "åœæ­¢Redis TCPæœåŠ¡å™¨..."
	@pkill -f "start_redis_tcp_server.lua" || true
	@echo "âœ“ Redis TCPæœåŠ¡å™¨å·²åœæ­¢"

# é›†æˆæµ‹è¯•ï¼šRedis TCPæœåŠ¡å™¨ä¸ä¸šåŠ¡å®ä¾‹
redis-tcp-integration: build
	@echo "è¿è¡ŒRedis TCPæœåŠ¡å™¨ä¸ä¸šåŠ¡å®ä¾‹é›†æˆæµ‹è¯•..."
	@echo "1. å¯åŠ¨ä¸šåŠ¡å®ä¾‹..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) start_business_instances.lua &
	@sleep 2
	@echo "2. å¯åŠ¨Redis TCPæœåŠ¡å™¨..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) start_redis_tcp_server.lua &
	@sleep 2
	@echo "3. è¿è¡Œé›†æˆæµ‹è¯•..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) demo_business_separation.lua
	@echo "4. åœæ­¢æœåŠ¡..."
	@pkill -f "start_business_instances.lua" || true
	@pkill -f "start_redis_tcp_server.lua" || true
	@echo "âœ“ Redis TCPæœåŠ¡å™¨é›†æˆæµ‹è¯•å®Œæˆ"

# Redis TCPæœåŠ¡å™¨è”è°ƒé›†æˆæµ‹è¯•
redis-tcp-integration-full: build
	@echo "è¿è¡ŒRedis TCPæœåŠ¡å™¨å®Œæ•´è”è°ƒé›†æˆæµ‹è¯•..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' $(LUAJIT_BIN) tests/integrate_redis_tcp_server.lua

# æµ‹è¯•cjson.soåº“åŠŸèƒ½
test-cjson:
	@echo "ğŸ”§ æµ‹è¯• cjson.so åº“åŠŸèƒ½..."
	@LUA_CPATH="./lib/?.so;../lib/?.so;./?.so;;" $(LUAJIT_BIN) -e "local cjson=require('cjson'); local t={name='dennis',age=18}; local s=cjson.encode(t); print(s); print(cjson.decode(s).name)"
	@echo "âœ“ cjson.so åº“æµ‹è¯•å®Œæˆ"

# æµ‹è¯•micro_tsæ’ä»¶å¤šç‰ˆæœ¬æ€§èƒ½å¯¹æ¯”
test-micro-ts:
	@echo "ğŸš€ æµ‹è¯• micro_ts æ’ä»¶å¤šç‰ˆæœ¬æ€§èƒ½å¯¹æ¯”..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' LUA_CPATH="./lib/?.so;../lib/?.so;./?.so;;" $(LUAJIT_BIN) lua/test_micro_ts_multi_version.lua
	@echo "âœ“ micro_ts æ’ä»¶å¤šç‰ˆæœ¬æ€§èƒ½å¯¹æ¯”æµ‹è¯•å®Œæˆ"

# è¿è¡Œæ’ä»¶å¯¹æ¯”åˆ†æ
test-plugin-comparison:
	@echo "ğŸ“Š è¿è¡Œæ’ä»¶å¯¹æ¯”åˆ†æ..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' LUA_CPATH="./lib/?.so;../lib/?.so;./?.so;;" $(LUAJIT_BIN) lua/plugin_comparison_analysis.lua
	@echo "âœ“ æ’ä»¶å¯¹æ¯”åˆ†æå®Œæˆ"

# è¿è¡Œæ’ä»¶å¯¹æ¯”åˆ†æå¹¶ä¿å­˜ç»“æœ
test-plugin-comparison-save:
	@echo "ğŸ“Š è¿è¡Œæ’ä»¶å¯¹æ¯”åˆ†æå¹¶ä¿å­˜ç»“æœ..."
	@LUA_PATH='./lua/?.lua;./?.lua;;' LUA_CPATH="./lib/?.so;../lib/?.so;./?.so;;" $(LUAJIT_BIN) lua/plugin_comparison_analysis.lua > plugin_comparison_final.txt 2>&1
	@echo "âœ“ æ’ä»¶å¯¹æ¯”åˆ†æå®Œæˆï¼Œç»“æœå·²ä¿å­˜åˆ° plugin_comparison_final.txt"

# æµ‹è¯•æ‰€æœ‰æ’ä»¶åŠŸèƒ½
test-plugins-all:
	@echo "ğŸ”§ æµ‹è¯•æ‰€æœ‰æ’ä»¶åŠŸèƒ½..."
	@LUA_CPATH="./lib/?.so;../lib/?.so;./?.so;;" $(LUAJIT_BIN) -e " \
		local plugins = { \
		  'micro_ts_plugin', 'micro_ts_plugin_optimized', 'micro_ts_plugin_final', \
		  'stock_quote_binary', 'stock_quote_compressed', 'stock_quote_optimized', \
		  'iot_data', 'payment_system', 'user_behavior', 'market_data', \
		  'log_analysis', 'sensor_data', 'stock_quote_v2' \
		} \
		\
		for _, plugin_name in ipairs(plugins) do \
		  local success, plugin = pcall(require, 'lua.' .. plugin_name) \
		  if success then \
		    local instance = plugin:new() \
		    local test_data = { \
		      stock_code = '000001', \
		      timestamp = 1760272200, \
		      market = 'SH', \
		      price = 1000, \
		      volume = 10000, \
		      ch = 1, \
		      side = 0, \
		      order_no = 1234567890, \
		      tick_no = 9876543210 \
		    } \
		    \
		    local rowkey, qualifier = instance:encode_rowkey(test_data.stock_code, test_data.timestamp, test_data.market) \
		    local value = instance:encode_value(test_data) \
		    local decoded_rowkey = instance:decode_rowkey(rowkey) \
		    local decoded_value = instance:decode_value(value) \
		    \
		    local timestamp_match = test_data.timestamp == decoded_rowkey.timestamp \
		    local stock_code_match = test_data.stock_code == decoded_rowkey.stock_code \
		    local price_match = test_data.price == decoded_value.price \
		    \
		    if timestamp_match and stock_code_match and price_match then \
		      print('âœ“', plugin_name, 'æµ‹è¯•é€šè¿‡') \
		    else \
		      print('âœ—', plugin_name, 'æµ‹è¯•å¤±è´¥') \
		    end \
		  else \
		    print('âœ—', plugin_name, 'åŠ è½½å¤±è´¥') \
		  end \
		end \
	"
	@echo "âœ“ æ‰€æœ‰æ’ä»¶åŠŸèƒ½æµ‹è¯•å®Œæˆ"

# æµ‹è¯•micro_ts_finalæ’ä»¶ä¿®å¤
test-micro-ts-final-fix:
	@echo "ğŸ”§ æµ‹è¯• micro_ts_final æ’ä»¶æ—¶é—´æˆ³ä¿®å¤..."
	@LUA_CPATH="./lib/?.so;../lib/?.so;./?.so;;" $(LUAJIT_BIN) -e " \
		local MicroTsPluginFinal = require('lua.micro_ts_plugin_final') \
		local plugin = MicroTsPluginFinal:new() \
		\
		-- æµ‹è¯•æ•°æ® \
		local test_data = { \
		  stock_code = '000001', \
		  timestamp = 1760272200,  -- 2024-07-12 10:30:00 \
		  market = 'SH', \
		  price = 1000, \
		  volume = 10000, \
		  ch = 1, \
		  side = 0, \
		  order_no = 1234567890, \
		  tick_no = 9876543210 \
		} \
		\
		-- ç¼–ç  \
		local rowkey, qualifier = plugin:encode_rowkey(test_data.stock_code, test_data.timestamp, test_data.market) \
		local value = plugin:encode_value(test_data) \
		\
		-- è§£ç  \
		local decoded_rowkey = plugin:decode_rowkey(rowkey) \
		local decoded_value = plugin:decode_value(value) \
		\
		-- éªŒè¯ \
		print('åŸå§‹æ—¶é—´æˆ³:', test_data.timestamp) \
		print('è§£ç æ—¶é—´æˆ³:', decoded_rowkey.timestamp) \
		print('æ—¶é—´æˆ³åŒ¹é…:', test_data.timestamp == decoded_rowkey.timestamp) \
		print('åŸå§‹è‚¡ç¥¨ä»£ç :', test_data.stock_code) \
		print('è§£ç è‚¡ç¥¨ä»£ç :', decoded_rowkey.stock_code) \
		print('è‚¡ç¥¨ä»£ç åŒ¹é…:', test_data.stock_code == decoded_rowkey.stock_code) \
		print('åŸå§‹ä»·æ ¼:', test_data.price) \
		print('è§£ç ä»·æ ¼:', decoded_value.price) \
		print('ä»·æ ¼åŒ¹é…:', test_data.price == decoded_value.price) \
		\
		-- æ€§èƒ½æµ‹è¯• \
		local perf = plugin:performance_test(10000) \
		print('ç¼–ç æ€§èƒ½:', perf.encode_ops_per_sec, 'ops/sec') \
		print('è§£ç æ€§èƒ½:', perf.decode_ops_per_sec, 'ops/sec') \
	"
	@echo "âœ“ micro_ts_final æ’ä»¶æ—¶é—´æˆ³ä¿®å¤æµ‹è¯•å®Œæˆ"

# æŸ¥çœ‹micro_tsæ’ä»¶æ€§èƒ½å¯¹æ¯”å›¾è¡¨
view-micro-ts-charts:
	@echo "ğŸ“Š æ‰“å¼€ micro_ts æ’ä»¶æ€§èƒ½å¯¹æ¯”å›¾è¡¨..."
	@if command -v open >/dev/null 2>&1; then \
		open micro_ts_performance_charts.html; \
	elif command -v xdg-open >/dev/null 2>&1; then \
		xdg-open micro_ts_performance_charts.html; \
	else \
		echo "è¯·æ‰‹åŠ¨æ‰“å¼€ micro_ts_performance_charts.html æ–‡ä»¶æŸ¥çœ‹å›¾è¡¨"; \
	fi

# æŸ¥çœ‹micro_tsæ’ä»¶åˆ†ææŒ‡å—
show-micro-ts-guide:
	@echo "ğŸ“– æ˜¾ç¤º micro_ts æ’ä»¶åˆ†ææŒ‡å—..."
	@cat micro_ts_analysis_guide.md

# ä»£ç è´¨é‡æ£€æŸ¥
lint:
	@echo "æ£€æŸ¥ Lua ä»£ç è´¨é‡..."
	@for file in $(LUA_MODULES); do \
		if [ -f "$$file" ]; then \
			echo "æ£€æŸ¥ $$file..."; \
			$(LUAJIT_BIN) -bl $$file > /dev/null 2>&1 && echo "âœ“ $$file è¯­æ³•æ­£ç¡®" || echo "âœ— $$file è¯­æ³•é”™è¯¯"; \
		fi \
	done

# æ¸…ç†
clean:
	@echo "æ¸…ç†æ„å»ºæ–‡ä»¶..."
	@rm -rf $(OBJ_DIR) $(BIN_DIR) $(LIB_DIR)
	@rm -rf $(LOGS_DIR)/* $(DATA_DIR)/*
	@echo "æ¸…ç†V3æµ‹è¯•æ•°æ®..."
	@rm -rf test_v3_*/
	@rm -rf testdb*/
	@echo "âœ“ æ¸…ç†å®Œæˆ"

# æ¸…ç†V3æµ‹è¯•æ•°æ®
clean-v3:
	@echo "æ¸…ç†V3æµ‹è¯•æ•°æ®..."
	@rm -rf test_v3_*/
	@rm -rf data/testdb*/
	@rm -rf data/stock_data/
	@echo "âœ“ V3æµ‹è¯•æ•°æ®æ¸…ç†å®Œæˆ"

# å®‰è£…
PREFIX ?= /usr/local
install: build
	@echo "å®‰è£… $(PROJECT_NAME) v$(VERSION)..."
	@install -d $(PREFIX)/bin
	@install -d $(PREFIX)/share/$(PROJECT_NAME)/lua
	@install -d $(PREFIX)/etc/$(PROJECT_NAME)
	@install -d $(PREFIX)/lib/lua/$(LUA_VERSION)
	@install -m 755 $(TARGET) $(PREFIX)/bin/
	@cp -r $(LUA_DIR)/* $(PREFIX)/share/$(PROJECT_NAME)/lua/
	@install -m 644 $(CONF_DIR)/stock-tsdb.conf $(PREFIX)/etc/$(PROJECT_NAME)/
	@echo "âœ“ å®‰è£…å®Œæˆ"
	@echo "å®‰è£…è·¯å¾„: $(PREFIX)"
	@echo "äºŒè¿›åˆ¶æ–‡ä»¶: $(PREFIX)/bin/stock-tsdb-server"
	@echo "é…ç½®æ–‡ä»¶: $(PREFIX)/etc/$(PROJECT_NAME)/stock-tsdb.conf"

# å¸è½½
uninstall:
	@echo "å¸è½½ $(PROJECT_NAME)..."
	@rm -f $(PREFIX)/bin/stock-tsdb-server
	@rm -rf $(PREFIX)/share/$(PROJECT_NAME)
	@rm -f $(PREFIX)/etc/$(PROJECT_NAME)/stock-tsdb.conf
	@rm -rf $(PREFIX)/etc/$(PROJECT_NAME)
	@echo "âœ“ å¸è½½å®Œæˆ"

# å¼€å‘æ¨¡å¼è¿è¡Œ
run-dev: build
	@echo "å¼€å‘æ¨¡å¼å¯åŠ¨..."
	@./$(TARGET) -c $(CONF_DIR)/stock-tsdb.conf -d

# ç”Ÿäº§æ¨¡å¼è¿è¡Œ
run-prod: build
	@echo "ç”Ÿäº§æ¨¡å¼å¯åŠ¨..."
	@if [ -f $(PREFIX)/etc/$(PROJECT_NAME)/stock-tsdb.conf ]; then \
		$(PREFIX)/bin/stock-tsdb-server -c $(PREFIX)/etc/$(PROJECT_NAME)/stock-tsdb.conf; \
	else \
		echo "é”™è¯¯: æœªæ‰¾åˆ°ç”Ÿäº§é…ç½®æ–‡ä»¶ï¼Œè¯·å…ˆè¿è¡Œ make install"; \
		exit 1; \
	fi

# æ‰“åŒ…
dist: clean
	@echo "åˆ›å»ºå‘å¸ƒåŒ…..."
	@mkdir -p dist
	@tar -czf dist/$(PROJECT_NAME)-$(VERSION)-$(PLATFORM).tar.gz \
		--exclude=.git \
		--exclude=dist \
		--exclude=logs \
		--exclude=data \
		--exclude=*.log \
		.
	@echo "âœ“ å‘å¸ƒåŒ…å·²åˆ›å»º: dist/$(PROJECT_NAME)-$(VERSION)-$(PLATFORM).tar.gz"

# æ˜¾ç¤ºé¡¹ç›®ä¿¡æ¯
info:
	@echo "$(PROJECT_NAME) v$(VERSION)"
	@echo "å¹³å°: $(PLATFORM)"
	@echo "LuaJIT: $(shell $(LUAJIT_BIN) -v)"
	@echo "LuaRocks: $(shell $(LUAROCKS) --version | head -1)"

# å¸®åŠ©
help:
	@echo "$(PROJECT_NAME) v$(VERSION) Makefile"
	@echo ""
	@echo "ä¸»è¦ç›®æ ‡:"
	@echo "  make              - æ£€æŸ¥ä¾èµ–å¹¶æ„å»ºé¡¹ç›®"
	@echo "  make build        - æ„å»ºé¡¹ç›®"
	@echo "  make install      - å®‰è£…åˆ°ç³»ç»Ÿ (PREFIX=$(PREFIX))"
	@echo "  make test         - è¿è¡Œæ‰€æœ‰æµ‹è¯•"
	@echo "  make test-core    - è¿è¡Œæ ¸å¿ƒæµ‹è¯•ï¼ˆæ¨èï¼‰"
	@echo "  make test-cluster - è¿è¡Œæ‰€æœ‰é›†ç¾¤æµ‹è¯•"
	@echo "  make test-cluster-all - è¿è¡Œæ‰€æœ‰é›†ç¾¤ç›¸å…³æµ‹è¯•ï¼ˆåŒ…æ‹¬é›†æˆæµ‹è¯•ï¼‰"
	@echo "  make clean        - æ¸…ç†æ„å»ºæ–‡ä»¶"
	@echo "  make clean-v3     - æ¸…ç†V3æµ‹è¯•æ•°æ®"
	@echo "  make help         - æ˜¾ç¤ºæ­¤å¸®åŠ©"
	@echo ""
	@echo "å¿«é€ŸéªŒè¯ç›®æ ‡:"
	@echo "  make health-check        - ç³»ç»Ÿå¥åº·æ£€æŸ¥"
	@echo "  make test-cjson          - æµ‹è¯• cjson.so åº“åŠŸèƒ½"
	@echo "  make test-micro-ts       - æµ‹è¯• micro_ts æ’ä»¶å¤šç‰ˆæœ¬æ€§èƒ½å¯¹æ¯”"
	@echo "  make view-micro-ts-charts - æŸ¥çœ‹ micro_ts æ’ä»¶æ€§èƒ½å¯¹æ¯”å›¾è¡¨"
	@echo "  make show-micro-ts-guide - æ˜¾ç¤º micro_ts æ’ä»¶åˆ†ææŒ‡å—"
	@echo "  make test-config-manager - è¿è¡Œé…ç½®ç®¡ç†å™¨å®Œæ•´æµ‹è¯•"
	@echo "  make test-config-manager-quick - è¿è¡Œé…ç½®ç®¡ç†å™¨å¿«é€Ÿæµ‹è¯•"
	@echo ""
	@echo "ç›‘æ§ç³»ç»Ÿç›®æ ‡:"
	@echo "  make monitoring-start    - å¯åŠ¨ç›‘æ§ç³»ç»Ÿï¼ˆPrometheus + å…ƒæ•°æ®WebæœåŠ¡å™¨ï¼‰"
	@echo "  make monitoring-stop     - åœæ­¢ç›‘æ§ç³»ç»Ÿ"
	@echo "  make monitoring-status   - æ£€æŸ¥ç›‘æ§ç³»ç»ŸçŠ¶æ€"
	@echo "  make monitoring-check    - è¿è¡Œç›‘æ§çŠ¶æ€æ£€æŸ¥è„šæœ¬"
	@echo "  make prometheus-start    - å¯åŠ¨ Prometheus æœåŠ¡"
	@echo "  make prometheus-stop     - åœæ­¢ Prometheus æœåŠ¡"
	@echo "  make prometheus-status   - æ£€æŸ¥ Prometheus æœåŠ¡çŠ¶æ€"
	@echo "  make view-metrics        - æŸ¥çœ‹ç›‘æ§æŒ‡æ ‡"
	@echo "  make test-monitoring     - æµ‹è¯•ç›‘æ§ç«¯ç‚¹"
	@echo ""
	@echo "ä¸šåŠ¡æ•°æ®ç³»ç»Ÿç›®æ ‡:"
	@echo "  make business-web-start    - å¯åŠ¨ä¸šåŠ¡æ•°æ®Webç•Œé¢ï¼ˆSQLæŸ¥è¯¢ç•Œé¢ï¼‰"
	@echo "  make business-web-stop     - åœæ­¢ä¸šåŠ¡æ•°æ®Webç•Œé¢"
	@echo "  make business-web-status   - æ£€æŸ¥ä¸šåŠ¡æ•°æ®Webç•Œé¢çŠ¶æ€"
	@echo "  make business-web-check    - æ£€æŸ¥ä¸šåŠ¡æ•°æ®Webç•Œé¢åŠŸèƒ½"
	@echo "  make sql-query-test        - æµ‹è¯•SQLæŸ¥è¯¢åŠŸèƒ½"
	@echo "  make view-business-metrics - æŸ¥çœ‹ä¸šåŠ¡æ•°æ®æŒ‡æ ‡"
	@echo "  make business-system-start - å¯åŠ¨å®Œæ•´ä¸šåŠ¡æ•°æ®ç³»ç»Ÿ"
	@echo "  make business-system-stop  - åœæ­¢ä¸šåŠ¡æ•°æ®ç³»ç»Ÿ"
	@echo "  make business-system-status - æ£€æŸ¥ä¸šåŠ¡æ•°æ®ç³»ç»ŸçŠ¶æ€"
	@echo ""
	@echo "å…ƒæ•°æ®ç®¡ç†ç›®æ ‡:"
	@echo "  make metadata-init       - åˆå§‹åŒ–å…ƒæ•°æ®é…ç½®"
	@echo "  make metadata-list       - æŸ¥è¯¢å…ƒæ•°æ®åˆ—è¡¨"
	@echo "  make metadata-update     - ä¿®æ”¹å…ƒæ•°æ®é…ç½®"
	@echo ""
	@echo "æ’ä»¶æµ‹è¯•ç›®æ ‡:"
	@echo "  make test-plugin-comparison      - è¿è¡Œæ’ä»¶å¯¹æ¯”åˆ†æ"
	@echo "  make test-plugin-comparison-save - è¿è¡Œæ’ä»¶å¯¹æ¯”åˆ†æå¹¶ä¿å­˜ç»“æœ"
	@echo "  make test-plugins-all            - æµ‹è¯•æ‰€æœ‰æ’ä»¶åŠŸèƒ½"
	@echo "  make test-micro-ts-final-fix     - æµ‹è¯• micro_ts_final æ’ä»¶æ—¶é—´æˆ³ä¿®å¤"
	@echo ""
	@echo "V3å­˜å‚¨å¼•æ“æµ‹è¯•ç›®æ ‡:"
	@echo "  make test-v3              - è¿è¡Œæ‰€æœ‰V3ç‰ˆæœ¬æµ‹è¯•ï¼ˆæ¨èï¼‰"
	@echo "  make test-v3-basic        - V3åŸºç¡€ç‰ˆæœ¬æµ‹è¯•"
	@echo "  make test-v3-integrated  - V3é›†æˆç‰ˆæœ¬æµ‹è¯•"
	@echo "  make test-v3-comparison   - V3ç‰ˆæœ¬å¯¹æ¯”æµ‹è¯•"
	@echo "  make test-v3-validation   - V3ç‰ˆæœ¬åŠŸèƒ½éªŒè¯"
	@echo "  make test-v3-performance  - V3æ€§èƒ½è¯¦ç»†åˆ†æ"
	@echo "  make test-v3-final        - V3æœ€ç»ˆå¯¹æ¯”æµ‹è¯•"
	@echo ""
	@echo "é›†ç¾¤æµ‹è¯•ç›®æ ‡:"
	@echo "  make test-cluster          - è¿è¡Œæ‰€æœ‰é›†ç¾¤æµ‹è¯•ï¼ˆæ¨èï¼‰"
	@echo "  make test-cluster-simple   - è¿è¡Œç®€å•é›†ç¾¤æµ‹è¯•"
	@echo "  make test-cluster-tsdb     - è¿è¡ŒTSDBé›†ç¾¤æµ‹è¯•"
	@echo "  make test-cluster-business - è¿è¡Œä¸šåŠ¡é›†ç¾¤æµ‹è¯•"
	@echo "  make test-cluster-consul   - è¿è¡ŒConsulé›†æˆæµ‹è¯•"
	@echo "  make test-cluster-optimized - è¿è¡Œä¼˜åŒ–é›†ç¾¤æµ‹è¯•"
	@echo "  make test-cluster-all      - è¿è¡Œæ‰€æœ‰é›†ç¾¤ç›¸å…³æµ‹è¯•ï¼ˆåŒ…æ‹¬é›†æˆæµ‹è¯•ï¼‰"
	@echo ""
	@echo "å¼€å‘ç›®æ ‡:"
	@echo "  make install-deps - å®‰è£… Lua ä¾èµ–åŒ…"
	@echo "  make install-cjson - å®‰è£… lua-cjson åº“ï¼ˆJSONæ”¯æŒï¼‰"
	@echo "  make build-micro-ts - ç¼–è¯‘ micro_ts åº“ï¼ˆé«˜æ€§èƒ½æ‰“åŒ…/è§£åŒ…ï¼‰"
	@echo "  make run-dev      - å¼€å‘æ¨¡å¼è¿è¡Œ"
	@echo "  make run-prod     - ç”Ÿäº§æ¨¡å¼è¿è¡Œ"
	@echo "  make lint         - ä»£ç è´¨é‡æ£€æŸ¥"
	@echo ""
	@echo "Redisé›†ç¾¤æœåŠ¡å™¨ç›®æ ‡:"
	@echo "  make redis-server        - å¯åŠ¨Redisé›†ç¾¤æœåŠ¡å™¨ï¼ˆå‰å°æ¨¡å¼ï¼‰"
	@echo "  make redis-server-daemon - å¯åŠ¨Redisé›†ç¾¤æœåŠ¡å™¨ï¼ˆåå°æ¨¡å¼ï¼‰"
	@echo "  make redis-test          - æµ‹è¯•Redisé›†ç¾¤æœåŠ¡å™¨"
	@echo "  make redis-stop          - åœæ­¢Redisé›†ç¾¤æœåŠ¡å™¨"
	@echo ""
	@echo "Redisé›†ç¾¤æœåŠ¡å™¨ä¿¡æ¯:"
	@echo "  ç›‘å¬ç«¯å£: 6379 (Redisåè®®)"
	@echo "  é›†ç¾¤ç«¯å£: 5555 (ZeroMQé›†ç¾¤é€šä¿¡)"
	@echo "  æ”¯æŒå‘½ä»¤: PING, ECHO, SET, GET, TS.ADD, TS.RANGE, CLUSTER, INFO"
	@echo ""
		@echo "ä½¿ç”¨ç¤ºä¾‹:"
	@echo "  make health-check         # ç³»ç»Ÿå¥åº·æ£€æŸ¥"
	@echo "  make test-quick           # å¿«é€ŸéªŒè¯æµ‹è¯•"
	@echo "  make test-v3              # è¿è¡ŒV3ç‰ˆæœ¬å®Œæ•´æµ‹è¯•"
	@echo "  make test-v3-basic        # ä»…æµ‹è¯•V3åŸºç¡€ç‰ˆæœ¬"
	@echo "  make test-v3-comparison   # è¿è¡ŒV3ç‰ˆæœ¬å¯¹æ¯”æµ‹è¯•"
	@echo "  make test-cluster         # è¿è¡Œæ‰€æœ‰é›†ç¾¤æµ‹è¯•"
	@echo "  make test-cluster-simple  # è¿è¡Œç®€å•é›†ç¾¤æµ‹è¯•"
	@echo "  make test-cluster-business # è¿è¡Œä¸šåŠ¡é›†ç¾¤æµ‹è¯•"
	@echo "  make redis-server-daemon  # å¯åŠ¨Redisé›†ç¾¤æœåŠ¡å™¨"
	@echo "  make redis-test           # æµ‹è¯•æœåŠ¡å™¨åŠŸèƒ½"
	@echo "  make monitoring-start     # å¯åŠ¨ç›‘æ§ç³»ç»Ÿ"
	@echo "  make monitoring-status    # æ£€æŸ¥ç›‘æ§çŠ¶æ€"
	@echo "  make view-metrics         # æŸ¥çœ‹ç›‘æ§æŒ‡æ ‡"
	@echo "  make test-monitoring      # æµ‹è¯•ç›‘æ§ç«¯ç‚¹"
	@echo "  make business-system-start # å¯åŠ¨ä¸šåŠ¡æ•°æ®ç³»ç»Ÿ"
	@echo "  make business-web-check    # æ£€æŸ¥ä¸šåŠ¡æ•°æ®ç•Œé¢"
	@echo "  make sql-query-test       # æµ‹è¯•SQLæŸ¥è¯¢åŠŸèƒ½"
	@echo "  make stress-test-write    # å†™å…¥å‹åŠ›æµ‹è¯•"
	@echo "  make stress-test-read     # è¯»å–å‹åŠ›æµ‹è¯•"
	@echo "  make prepare-release      # å‡†å¤‡ç”Ÿäº§å‘å¸ƒ"
	@echo "  make github-setup         # è®¾ç½®GitHubä»“åº“"
	@echo "  redis-cli -p 6379 PING    # ä½¿ç”¨redis-cliæµ‹è¯•"
	@echo ""
		@echo "é«˜çº§ç›®æ ‡:"
	@echo "  make dist         - åˆ›å»ºå‘å¸ƒåŒ…"
	@echo "  make info         - æ˜¾ç¤ºé¡¹ç›®ä¿¡æ¯"
	@echo "  make uninstall    - ä»ç³»ç»Ÿå¸è½½"
	@echo ""
	@echo "å‹åŠ›æµ‹è¯•ç›®æ ‡:"
	@echo "  make stress-test-write - å†™å…¥å‹åŠ›æµ‹è¯•"
	@echo "  make stress-test-read  - è¯»å–å‹åŠ›æµ‹è¯•"
	@echo "  make stress-test-mixed - æ··åˆå‹åŠ›æµ‹è¯•"
	@echo "  make stress-test-all   - è¿è¡Œæ‰€æœ‰å‹åŠ›æµ‹è¯•"
	@echo ""
	@echo "ç”Ÿäº§å‘å¸ƒç›®æ ‡:"
	@echo "  make prepare-release   - å‡†å¤‡ç”Ÿäº§å‘å¸ƒ"
	@echo "  make release-package   - æ„å»ºå‘å¸ƒåŒ…"
	@echo ""
	@echo "GitHub ä¸Šä¼ ç›®æ ‡:"
	@echo "  make github-setup      - è®¾ç½® GitHub ä»“åº“"
	@echo "  make github-upload     - ä¸Šä¼ ä»£ç åˆ° GitHub"
	@echo "  make github-release    - åˆ›å»º GitHub Release"
	@echo ""
	@echo "Ubuntu/Debian æ‰“åŒ…ç›®æ ‡:"
	@echo "  make package-ubuntu-debian - æ‰“åŒ… Ubuntu/Debian ç³»ç»Ÿ"
	@echo "  make package-deb          - åˆ›å»º Debian åŒ…"
	@echo "  make package-appimage     - åˆ›å»º AppImage åŒ…"
	@echo "  make package-rpm          - åˆ›å»º RPM åŒ…"
	@echo "  make package-docker       - åˆ›å»º Docker é•œåƒ"
	@echo "  make package-snap         - åˆ›å»º Snap åŒ…"
	@echo "  make package-all          - åˆ›å»ºæ‰€æœ‰æ ¼å¼çš„åŒ…"
	@echo "  make install-ubuntu-debian - å®‰è£…åˆ° Ubuntu/Debian ç³»ç»Ÿ"
	@echo "  make install-packaging-deps - å®‰è£…æ‰“åŒ…ä¾èµ–"
	@echo ""
	@echo "å˜é‡:"
	@echo "  make install PREFIX=/opt/stock-tsdb  # è‡ªå®šä¹‰å®‰è£…è·¯å¾„"
	@echo ""
	@echo "å¹³å°: $(PLATFORM)"

# åˆ›å»ºå¿…è¦çš„ç›®å½•
directories: $(BIN_DIR) $(LIB_DIR) $(LOGS_DIR) $(DATA_DIR)

# Ubuntu/Debian æ‰“åŒ…ç›®æ ‡
.PHONY: package-ubuntu-debian package-deb package-appimage package-rpm package-docker package-snap install-ubuntu-debian

# æ‰“åŒ… Ubuntu/Debian ç³»ç»Ÿ
package-ubuntu-debian:
	@echo "ğŸ“¦ æ‰“åŒ… Ubuntu/Debian ç³»ç»Ÿ..."
	@./package_ubuntu_debian.sh --deb

# åˆ›å»º Debian åŒ…
package-deb:
	@echo "ğŸ“¦ åˆ›å»º Debian åŒ…..."
	@./package_ubuntu_debian.sh --deb

# åˆ›å»º AppImage åŒ…
package-appimage:
	@echo "ğŸ“¦ åˆ›å»º AppImage åŒ…..."
	@./package_ubuntu_debian.sh --appimage

# åˆ›å»º RPM åŒ…
package-rpm:
	@echo "ğŸ“¦ åˆ›å»º RPM åŒ…..."
	@./package_ubuntu_debian.sh --rpm

# åˆ›å»º Docker é•œåƒ
package-docker:
	@echo "ğŸ“¦ åˆ›å»º Docker é•œåƒ..."
	@./package_ubuntu_debian.sh --docker

# åˆ›å»º Snap åŒ…
package-snap:
	@echo "ğŸ“¦ åˆ›å»º Snap åŒ…..."
	@./package_ubuntu_debian.sh --snap

# åˆ›å»ºæ‰€æœ‰æ ¼å¼çš„åŒ…
package-all:
	@echo "ğŸ“¦ åˆ›å»ºæ‰€æœ‰æ ¼å¼çš„åŒ…..."
	@./package_ubuntu_debian.sh --all

# å®‰è£…åˆ° Ubuntu/Debian ç³»ç»Ÿ
install-ubuntu-debian:
	@echo "ğŸ”§ å®‰è£…åˆ° Ubuntu/Debian ç³»ç»Ÿ..."
	@./install_ubuntu_debian.sh

# å®‰è£…æ‰“åŒ…ä¾èµ–
install-packaging-deps:
	@echo "ğŸ”§ å®‰è£…æ‰“åŒ…ä¾èµ–..."
	@./package_ubuntu_debian.sh --install-deps

# ç›‘æ§ç³»ç»Ÿç›®æ ‡
.PHONY: monitoring-start monitoring-stop monitoring-status monitoring-check prometheus-start prometheus-stop prometheus-status

# å¯åŠ¨ç›‘æ§ç³»ç»Ÿ
monitoring-start:
	@echo "ğŸ” å¯åŠ¨ç›‘æ§ç³»ç»Ÿ..."
	@if [ -f scripts/start_prometheus.sh ]; then \
		echo "å¯åŠ¨ Prometheus ç›‘æ§æœåŠ¡..."; \
		./scripts/start_prometheus.sh start; \
	else \
		echo "è­¦å‘Š: æœªæ‰¾åˆ° Prometheus å¯åŠ¨è„šæœ¬"; \
	fi
	@echo "å¯åŠ¨å…ƒæ•°æ® Web æœåŠ¡å™¨..."
	@if pgrep -f "luajit web/start_metadata_web.lua" > /dev/null; then \
		echo "å…ƒæ•°æ® Web æœåŠ¡å™¨å·²åœ¨è¿è¡Œ"; \
	else \
		cd /Users/moyong/project/ai/myrocks/stock-tsdb && luajit web/start_metadata_web.lua & \
		echo "å…ƒæ•°æ® Web æœåŠ¡å™¨å·²å¯åŠ¨"; \
	fi
	@echo "âœ“ ç›‘æ§ç³»ç»Ÿå¯åŠ¨å®Œæˆ"

# ä¸šåŠ¡æ•°æ®Webç•Œé¢ç›®æ ‡
.PHONY: business-web-start business-web-stop business-web-status business-web-check sql-query-test view-business-metrics business-system-start business-system-stop business-system-status

# å¯åŠ¨ä¸šåŠ¡æ•°æ®Webç•Œé¢
business-web-start:
	@echo "ğŸš€ å¯åŠ¨ä¸šåŠ¡æ•°æ®Webç•Œé¢..."
	@cd web && luajit start_business_web.lua &
	@echo "âœ… ä¸šåŠ¡æ•°æ®Webç•Œé¢å·²å¯åŠ¨ (ç«¯å£: 8081)"
	@echo "ğŸ“Š è®¿é—®åœ°å€: http://localhost:8081"
	@echo "ğŸ” åŠŸèƒ½: SQLæŸ¥è¯¢ã€èšåˆå‡½æ•°ã€æ•°æ®å¯è§†åŒ–"

# åœæ­¢ä¸šåŠ¡æ•°æ®Webç•Œé¢
business-web-stop:
	@echo "ğŸ›‘ åœæ­¢ä¸šåŠ¡æ•°æ®Webç•Œé¢..."
	@-pkill -f "luajit start_business_web.lua" 2>/dev/null || true
	@echo "âœ… ä¸šåŠ¡æ•°æ®Webç•Œé¢å·²åœæ­¢"

# æ£€æŸ¥ä¸šåŠ¡æ•°æ®Webç•Œé¢çŠ¶æ€
business-web-status:
	@echo "ğŸ“Š æ£€æŸ¥ä¸šåŠ¡æ•°æ®Webç•Œé¢çŠ¶æ€..."
	@if curl -s http://localhost:8081/health >/dev/null 2>&1; then \
		echo "âœ… ä¸šåŠ¡æ•°æ®Webç•Œé¢è¿è¡Œæ­£å¸¸"; \
		curl -s http://localhost:8081/health | python3 -m json.tool 2>/dev/null || curl -s http://localhost:8081/health; \
	else \
		echo "âŒ ä¸šåŠ¡æ•°æ®Webç•Œé¢æœªè¿è¡Œ"; \
	fi

# æ£€æŸ¥ä¸šåŠ¡æ•°æ®Webç•Œé¢åŠŸèƒ½
business-web-check:
	@echo "ğŸ” æ£€æŸ¥ä¸šåŠ¡æ•°æ®Webç•Œé¢åŠŸèƒ½..."
	@echo "ğŸ“‹ æµ‹è¯•æ•°æ®è¡¨åˆ—è¡¨æ¥å£..."
	@curl -s http://localhost:8081/business/tables | python3 -m json.tool 2>/dev/null || curl -s http://localhost:8081/business/tables
	@echo ""
	@echo "ğŸ” æµ‹è¯•å¥åº·æ£€æŸ¥æ¥å£..."
	@curl -s http://localhost:8081/health | python3 -m json.tool 2>/dev/null || curl -s http://localhost:8081/health

# æµ‹è¯•SQLæŸ¥è¯¢åŠŸèƒ½
sql-query-test:
	@echo "ğŸ§ª æµ‹è¯•SQLæŸ¥è¯¢åŠŸèƒ½..."
	@echo "ğŸ“Š æ‰§è¡Œç¤ºä¾‹æŸ¥è¯¢: SELECT COUNT(*) FROM stock_quotes"
	@curl -s -X POST http://localhost:8081/business/query \
		-H "Content-Type: application/json" \
		-d '{"sql":"SELECT COUNT(*) FROM stock_quotes"}' | \
		python3 -m json.tool 2>/dev/null || \
		curl -s -X POST http://localhost:8081/business/query \
		-H "Content-Type: application/json" \
		-d '{"sql":"SELECT COUNT(*) FROM stock_quotes"}'

# æŸ¥çœ‹ä¸šåŠ¡æ•°æ®æŒ‡æ ‡
view-business-metrics:
	@echo "ğŸ“ˆ æŸ¥çœ‹ä¸šåŠ¡æ•°æ®æŒ‡æ ‡..."
	@curl -s http://localhost:8081/health | python3 -m json.tool 2>/dev/null || curl -s http://localhost:8081/health

# å®Œæ•´ä¸šåŠ¡æ•°æ®ç³»ç»Ÿå¯åŠ¨
business-system-start:
	@echo "ğŸš€ å¯åŠ¨å®Œæ•´ä¸šåŠ¡æ•°æ®ç³»ç»Ÿ..."
	@$(MAKE) business-web-start
	@echo ""
	@echo "âœ… ä¸šåŠ¡æ•°æ®ç³»ç»Ÿå¯åŠ¨å®Œæˆ"
	@echo "ğŸ“Š ä¸šåŠ¡æ•°æ®Webç•Œé¢: http://localhost:8081"
	@echo "ğŸ” æ”¯æŒåŠŸèƒ½:"
	@echo "   â€¢ SQLæŸ¥è¯¢ (SELECT, WHERE, GROUP BY)"
	@echo "   â€¢ èšåˆå‡½æ•° (COUNT, SUM, AVG, MAX, MIN)"
	@echo "   â€¢ æ•°æ®å¯è§†åŒ–è¡¨æ ¼"
	@echo "   â€¢ 7ç§ä¸šåŠ¡æ•°æ®ç±»å‹æ”¯æŒ"

# åœæ­¢ä¸šåŠ¡æ•°æ®ç³»ç»Ÿ
business-system-stop:
	@echo "ğŸ›‘ åœæ­¢ä¸šåŠ¡æ•°æ®ç³»ç»Ÿ..."
	@$(MAKE) business-web-stop
	@echo "âœ… ä¸šåŠ¡æ•°æ®ç³»ç»Ÿå·²åœæ­¢"

# æ£€æŸ¥ä¸šåŠ¡æ•°æ®ç³»ç»ŸçŠ¶æ€
business-system-status:
	@echo "ğŸ“Š æ£€æŸ¥ä¸šåŠ¡æ•°æ®ç³»ç»ŸçŠ¶æ€..."
	@$(MAKE) business-web-status

# åœæ­¢ç›‘æ§ç³»ç»Ÿ
monitoring-stop:
	@echo "ğŸ” åœæ­¢ç›‘æ§ç³»ç»Ÿ..."
	@if [ -f scripts/start_prometheus.sh ]; then \
		echo "åœæ­¢ Prometheus ç›‘æ§æœåŠ¡..."; \
		./scripts/start_prometheus.sh stop; \
	else \
		echo "è­¦å‘Š: æœªæ‰¾åˆ° Prometheus åœæ­¢è„šæœ¬"; \
	fi
	@echo "åœæ­¢å…ƒæ•°æ® Web æœåŠ¡å™¨..."
	@pkill -f "luajit web/start_metadata_web.lua" && echo "å…ƒæ•°æ® Web æœåŠ¡å™¨å·²åœæ­¢" || echo "å…ƒæ•°æ® Web æœåŠ¡å™¨æœªè¿è¡Œ"
	@echo "âœ“ ç›‘æ§ç³»ç»Ÿåœæ­¢å®Œæˆ"

# æ£€æŸ¥ç›‘æ§ç³»ç»ŸçŠ¶æ€
monitoring-status:
	@echo "ğŸ” ç›‘æ§ç³»ç»ŸçŠ¶æ€æ£€æŸ¥..."
	@echo "=== å…ƒæ•°æ® Web æœåŠ¡å™¨çŠ¶æ€ ==="
	@if pgrep -f "luajit web/start_metadata_web.lua" > /dev/null; then \
		echo "âœ“ å…ƒæ•°æ® Web æœåŠ¡å™¨: è¿è¡Œä¸­"; \
		curl -s http://localhost:8080/metrics | head -5; \
	else \
		echo "âœ— å…ƒæ•°æ® Web æœåŠ¡å™¨: æœªè¿è¡Œ"; \
	fi
	@echo ""
	@echo "=== Prometheus æœåŠ¡çŠ¶æ€ ==="
	@if command -v docker >/dev/null 2>&1; then \
		if docker ps | grep prometheus > /dev/null; then \
			echo "âœ“ Prometheus æœåŠ¡: è¿è¡Œä¸­"; \
		else \
			echo "âœ— Prometheus æœåŠ¡: æœªè¿è¡Œ"; \
		fi \
	else \
		echo "âš  Docker æœªå®‰è£…ï¼Œæ— æ³•æ£€æŸ¥ Prometheus çŠ¶æ€"; \
	fi
	@echo ""
	@echo "=== ç›‘æ§æŒ‡æ ‡ç«¯ç‚¹ ==="
	@if curl -s http://localhost:8080/metrics > /dev/null 2>&1; then \
		echo "âœ“ Prometheus æŒ‡æ ‡ç«¯ç‚¹: å¯è®¿é—®"; \
		curl -s http://localhost:8080/metrics | grep -c "stock_tsdb_" | xargs echo "  å¯ç”¨æŒ‡æ ‡æ•°é‡:"; \
	else \
		echo "âœ— Prometheus æŒ‡æ ‡ç«¯ç‚¹: ä¸å¯è®¿é—®"; \
	fi

# è¿è¡Œç›‘æ§çŠ¶æ€æ£€æŸ¥è„šæœ¬
monitoring-check:
	@echo "ğŸ” è¿è¡Œç›‘æ§çŠ¶æ€æ£€æŸ¥..."
	@if [ -f scripts/check_monitoring.sh ]; then \
		./scripts/check_monitoring.sh; \
	else \
		echo "é”™è¯¯: æœªæ‰¾åˆ°ç›‘æ§çŠ¶æ€æ£€æŸ¥è„šæœ¬"; \
		exit 1; \
	fi

# å¯åŠ¨ Prometheus æœåŠ¡
prometheus-start:
	@echo "ğŸ“Š å¯åŠ¨ Prometheus ç›‘æ§æœåŠ¡..."
	@if [ -f scripts/start_prometheus.sh ]; then \
		./scripts/start_prometheus.sh start; \
		echo "âœ“ Prometheus æœåŠ¡å¯åŠ¨å®Œæˆ"; \
	else \
		echo "é”™è¯¯: æœªæ‰¾åˆ° Prometheus å¯åŠ¨è„šæœ¬"; \
		exit 1; \
	fi

# åœæ­¢ Prometheus æœåŠ¡
prometheus-stop:
	@echo "ğŸ“Š åœæ­¢ Prometheus ç›‘æ§æœåŠ¡..."
	@if [ -f scripts/start_prometheus.sh ]; then \
		./scripts/start_prometheus.sh stop; \
		echo "âœ“ Prometheus æœåŠ¡åœæ­¢å®Œæˆ"; \
	else \
		echo "é”™è¯¯: æœªæ‰¾åˆ° Prometheus åœæ­¢è„šæœ¬"; \
		exit 1; \
	fi

# æ£€æŸ¥ Prometheus æœåŠ¡çŠ¶æ€
prometheus-status:
	@echo "ğŸ“Š Prometheus æœåŠ¡çŠ¶æ€..."
	@if command -v docker >/dev/null 2>&1; then \
		if docker ps | grep prometheus > /dev/null; then \
			echo "âœ“ Prometheus æœåŠ¡: è¿è¡Œä¸­"; \
			echo "  è®¿é—®åœ°å€: http://localhost:9090"; \
			echo "  ç›‘æ§ç›®æ ‡: http://localhost:8080/metrics"; \
		else \
			echo "âœ— Prometheus æœåŠ¡: æœªè¿è¡Œ"; \
		fi \
	else \
		echo "âš  Docker æœªå®‰è£…ï¼Œæ— æ³•æ£€æŸ¥ Prometheus çŠ¶æ€"; \
	fi

# æŸ¥çœ‹ç›‘æ§æŒ‡æ ‡
view-metrics:
	@echo "ğŸ“ˆ æŸ¥çœ‹ç›‘æ§æŒ‡æ ‡..."
	@if curl -s http://localhost:8080/metrics > /dev/null 2>&1; then \
		echo "=== ç³»ç»ŸæŒ‡æ ‡ ==="; \
		curl -s http://localhost:8080/metrics | grep -E "stock_tsdb_server_(uptime|version)" | head -5; \
		echo "" \
		echo "=== è¿æ¥æŒ‡æ ‡ ==="; \
		curl -s http://localhost:8080/metrics | grep -E "stock_tsdb_connections" | head -5; \
		echo "" \
		echo "=== å­˜å‚¨æŒ‡æ ‡ ==="; \
		curl -s http://localhost:8080/metrics | grep -E "stock_tsdb_storage" | head -5; \
		echo "" \
		echo "=== æ€§èƒ½æŒ‡æ ‡ ==="; \
		curl -s http://localhost:8080/metrics | grep -E "stock_tsdb_performance" | head -5; \
		echo "" \
		echo "=== ä¸šåŠ¡æŒ‡æ ‡ ==="; \
		curl -s http://localhost:8080/metrics | grep -E "stock_tsdb_business" | head -5; \
		echo "" \
		echo "=== é›†ç¾¤æŒ‡æ ‡ ==="; \
		curl -s http://localhost:8080/metrics | grep -E "stock_tsdb_cluster" | head -5; \
	else \
		echo "é”™è¯¯: æ— æ³•è®¿é—®ç›‘æ§æŒ‡æ ‡ç«¯ç‚¹"; \
		exit 1; \
	fi

# æµ‹è¯•ç›‘æ§ç«¯ç‚¹
test-monitoring:
	@echo "ğŸ§ª æµ‹è¯•ç›‘æ§ç«¯ç‚¹..."
	@echo "1. æ£€æŸ¥å…ƒæ•°æ® Web æœåŠ¡å™¨..."
	@if pgrep -f "luajit web/start_metadata_web.lua" > /dev/null; then \
		echo "   âœ“ æœåŠ¡å™¨è¿è¡Œæ­£å¸¸"; \
	else \
		echo "   âœ— æœåŠ¡å™¨æœªè¿è¡Œ"; \
		exit 1; \
	fi
	@echo "2. æµ‹è¯• Prometheus æŒ‡æ ‡ç«¯ç‚¹..."
	@if curl -s http://localhost:8080/metrics > /dev/null 2>&1; then \
		echo "   âœ“ æŒ‡æ ‡ç«¯ç‚¹å¯è®¿é—®"; \
		METRIC_COUNT=$$(curl -s http://localhost:8080/metrics | grep -c "stock_tsdb_"); \
		echo "   æŒ‡æ ‡æ•°é‡: $$METRIC_COUNT"; \
		if [ $$METRIC_COUNT -gt 0 ]; then \
			echo "   âœ“ æŒ‡æ ‡æ•°æ®æ­£å¸¸"; \
		else \
			echo "   âœ— æœªæ‰¾åˆ°ç›‘æ§æŒ‡æ ‡"; \
			exit 1; \
		fi \
	else \
		echo "   âœ— æŒ‡æ ‡ç«¯ç‚¹ä¸å¯è®¿é—®"; \
		exit 1; \
	fi
	@echo "3. æ£€æŸ¥å…³é”®æŒ‡æ ‡..."
	@curl -s http://localhost:8080/metrics | grep -E "stock_tsdb_server_uptime|stock_tsdb_connections_active|stock_tsdb_storage_data_points_total" | while read line; do \
		echo "   $$line"; \
	done
	@echo "âœ“ ç›‘æ§ç«¯ç‚¹æµ‹è¯•å®Œæˆ"

# å‹åŠ›æµ‹è¯•ç›®æ ‡
stress-test-write:
	@echo "ğŸš€ å¼€å§‹å†™å…¥å‹åŠ›æµ‹è¯•..."
	@chmod +x scripts/stress_test.lua
	@eval "$$(luarocks path)" && lua scripts/stress_test.lua write

stress-test-read:
	@echo "ğŸš€ å¼€å§‹è¯»å–å‹åŠ›æµ‹è¯•..."
	@chmod +x scripts/stress_test.lua
	@eval "$$(luarocks path)" && lua scripts/stress_test.lua read

stress-test-mixed:
	@echo "ğŸš€ å¼€å§‹æ··åˆå‹åŠ›æµ‹è¯•..."
	@chmod +x scripts/stress_test.lua
	@eval "$$(luarocks path)" && lua scripts/stress_test.lua mixed

stress-test-all:
	@echo "ğŸš€ è¿è¡Œå®Œæ•´çš„å‹åŠ›æµ‹è¯•å¥—ä»¶..."
	@$(MAKE) stress-test-write
	@$(MAKE) stress-test-read
	@$(MAKE) stress-test-mixed

# ç”Ÿäº§å‘å¸ƒç›®æ ‡
prepare-release:
	@echo "ğŸ“¦ å‡†å¤‡ç”Ÿäº§å‘å¸ƒ..."
	@chmod +x scripts/prepare_release.sh
	@./scripts/prepare_release.sh

release-package:
	@echo "ğŸ“¦ æ„å»ºå‘å¸ƒåŒ…..."
	@chmod +x scripts/prepare_release.sh
	@./scripts/prepare_release.sh --package-only

# GitHub ä¸Šä¼ ç›®æ ‡
github-setup:
	@echo "ğŸ”— è®¾ç½® GitHub ä»“åº“..."
	@chmod +x scripts/github_upload.sh
	@./scripts/github_upload.sh --setup

github-upload:
	@echo "ğŸ”— ä¸Šä¼ ä»£ç åˆ° GitHub..."
	@chmod +x scripts/github_upload.sh
	@./scripts/github_upload.sh

github-release:
	@echo "ğŸ”— åˆ›å»º GitHub Release..."
	@chmod +x scripts/github_upload.sh
	@./scripts/github_upload.sh --release