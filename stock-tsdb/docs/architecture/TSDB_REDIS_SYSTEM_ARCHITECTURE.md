# TSDB+Redis 系统架构图

## 概述

本系统实现了基于RocksDB的高性能时序数据库（TSDB）与Redis协议接口的完整集成架构，为股票行情、IOT、金融行情等多种业务场景提供统一的数据访问接口。

## 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          TSDB+Redis 系统架构                                │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Redis客户端    │    │   Redis客户端    │    │   Redis客户端    │
│  (标准Redis协议) │    │  (标准Redis协议) │    │  (标准Redis协议) │
└─────────┬───────┘    └─────────┬───────┘    └─────────┬───────┘
          │                      │                      │
          └──────────────────────┼──────────────────────┘
                                 │
          ┌──────────────────────┼──────────────────────┐
          │          Redis TCP服务器集群                 │
          │  • 监听6379端口                           │
          │  • 支持标准Redis协议                      │
          │  • 事件驱动架构(libevent/ZeroMQ)          │
          │  • 批量数据处理                          │
          └─────────────────┬───────────────────────────┘
                            │
          ┌─────────────────┼───────────────────────────┐
          │         统一数据访问层 (UnifiedDataAccess)   │
          │  • 业务类型自动识别                        │
          │  • 多实例透明路由                          │
          │  • 数据缓存机制                            │
          │  • 批量操作优化                            │
          └─────────────────┬───────────────────────────┘
                            │
          ┌─────────────────┼───────────────────────────┐
          │         业务路由管理器 (BusinessRouter)      │
          │  • 基于键前缀的业务识别                    │
          │  • 健康状态监控                            │
          │  • 故障自动切换                            │
          └─────────────────┬───────────────────────────┘
                            │
          ┌─────────────────┼───────────────────────────┐
          │         业务实例管理器 (BusinessInstanceManager) │
          │  • 7个业务实例生命周期管理                  │
          │  • 配置动态加载                            │
          │  • 故障自动恢复                            │
          └─────────────────┬───────────────────────────┘
                            │
          ┌─────────────────┼───────────────────────────┐
          │         业务实例集群 (7个独立实例)           │
          │  • 股票行情数据 (端口: 5555)               │
          │  • IOT数据 (端口: 5556)                    │
          │  • 金融行情数据 (端口: 5557)                │
          │  • 订单数据 (端口: 5558)                    │
          │  • 支付数据 (端口: 5559)                    │
          │  • 库存数据 (端口: 5560)                    │
          │  • 短信下发数据 (端口: 5561)                │
          └─────────────────┬───────────────────────────┘
                            │
          ┌─────────────────┼───────────────────────────┐
          │         TSDB存储引擎层 (RocksDB)            │
          │  • 高性能时序数据存储                      │
          │  • LZ4压缩算法                            │
          │  • 智能Compaction                         │
          │  • 冷热数据分离                            │
          └─────────────────────────────────────────────┘
```

## 核心组件详解

### 1. Redis TCP服务器层

#### 功能特性
- **标准Redis协议支持**：完全兼容Redis RESP协议
- **事件驱动架构**：基于libevent的高性能事件处理
- **ZeroMQ降级方案**：当libevent不可用时自动切换
- **批量数据处理**：BATCH_SET/BATCH_FLUSH命令支持
- **高并发支持**：支持大量并发客户端连接

#### 核心命令
```redis
# 基础命令
PING                    # 连接测试
ECHO "message"          # 消息回显
TIME                    # 服务器时间

# TSDB专用命令
TSDB_SET key timestamp value [data_type] [quality]  # 时间序列数据写入
TSDB_GET key start_time end_time [limit]            # 时间范围查询

# 批量操作命令
BATCH_SET key value timestamp                       # 批量数据添加
BATCH_FLUSH                                         # 批量数据刷新

# 集群管理命令
CLUSTER_INFO                                        # 集群状态查询
```

### 2. 统一数据访问层 (UnifiedDataAccess)

#### 架构设计
```lua
-- 统一数据访问层核心接口
local UnifiedDataAccess = {
    -- 数据操作接口
    set = function(key, value, options),      -- 数据写入
    get = function(key, options),             -- 数据查询
    delete = function(key, options),          -- 数据删除
    mset = function(key_value_pairs, options), -- 批量写入
    
    -- 统计监控接口
    get_stats = function(),                   -- 获取统计信息
    reset_stats = function(),                 -- 重置统计
    
    -- 缓存管理接口
    enable_cache = function(enable),          -- 缓存开关
    clear_cache = function()                  -- 缓存清理
}
```

#### 核心特性
- **业务透明路由**：自动识别业务类型并路由到对应实例
- **智能缓存机制**：支持数据缓存，提高查询性能
- **批量操作优化**：批量请求自动分组处理
- **统计监控**：完整的请求统计和性能监控

### 3. 业务路由管理器 (BusinessRouter)

#### 业务识别规则
```lua
-- 基于键前缀的业务类型识别
local business_patterns = {
    ["stock_"] = "stock_quotes",      -- 股票行情数据
    ["iot_"] = "iot_data",            -- IOT设备数据
    ["finance_"] = "financial_quotes", -- 金融行情数据
    ["order_"] = "order_data",        -- 订单数据
    ["payment_"] = "payment_data",    -- 支付数据
    ["inventory_"] = "inventory_data", -- 库存数据
    ["sms_"] = "sms_delivery"         -- 短信下发数据
}
```

#### 路由策略
- **前缀匹配**：基于键前缀自动识别业务类型
- **健康检查**：定期检查业务实例健康状态
- **故障切换**：自动切换到备用实例
- **负载均衡**：支持多实例负载均衡

### 4. 业务实例管理器 (BusinessInstanceManager)

#### 实例配置
```json
{
    "stock_quotes": {
        "port": 5555,
        "data_dir": "./data/stock_quotes",
        "compression": "lz4",
        "max_connections": 1000,
        "cold_hot_separation": true
    },
    "iot_data": {
        "port": 5556,
        "data_dir": "./data/iot_data",
        "compression": "lz4",
        "max_connections": 500,
        "cold_hot_separation": false
    }
    // ... 其他5个业务实例配置
}
```

#### 管理功能
- **实例生命周期管理**：启动、停止、重启实例
- **配置动态加载**：运行时配置更新
- **健康状态监控**：实时监控实例状态
- **故障自动恢复**：自动重启故障实例

### 5. TSDB存储引擎层

#### 存储方案

##### 方案A (V2) - 定长RowKey+大端字节序
```lua
-- RowKey格式: [股票代码]:[16位十六进制时间戳]:[2位十六进制数据类型]
"SH600519:00000000670c5a28:00"

-- Value格式: [8字节double值][1字节质量码]
```

##### 现有实现 (V1) - 字符串键值
```lua
-- 通用字符串键值存储
key = "stock_SH600519_1728462600"
value = "100.5|1"  -- 值|质量码
```

#### 性能特性
- **写入性能**：单线程180万笔/秒
- **读取性能**：P99延迟 < 0.6ms
- **压缩率**：4:1压缩比
- **存储效率**：每条记录约74字节

## 数据流向图

```
客户端请求 → Redis TCP服务器 → 统一数据访问层 → 业务路由管理器 → 业务实例 → TSDB存储
     ↓              ↓               ↓               ↓             ↓           ↓
 Redis协议    协议解析/命令    业务识别/路由    健康检查/负载    实例处理   数据持久化
             事件驱动处理      缓存管理         故障切换        压缩存储
```

## 部署架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           生产环境部署架构                                   │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   负载均衡器     │    │   负载均衡器     │    │   负载均衡器     │
│   (HAProxy)     │    │   (HAProxy)     │    │   (HAProxy)     │
└─────────┬───────┘    └─────────┬───────┘    └─────────┬───────┘
          │                      │                      │
          └──────────────────────┼──────────────────────┘
                                 │
          ┌──────────────────────┼──────────────────────┐
          │         Redis TCP服务器集群 (3节点)           │
          │  • 节点1: 192.168.1.10:6379                 │
          │  • 节点2: 192.168.1.11:6379                 │
          │  • 节点3: 192.168.1.12:6379                 │
          └─────────────────┬───────────────────────────┘
                            │
          ┌─────────────────┼───────────────────────────┐
          │         业务实例集群 (7个业务×3副本)         │
          │  • 股票行情: 3节点集群                       │
          │  • IOT数据: 3节点集群                       │
          │  • 金融行情: 3节点集群                       │
          │  • 订单数据: 3节点集群                       │
          │  • 支付数据: 3节点集群                       │
          │  • 库存数据: 3节点集群                       │
          │  • 短信下发: 3节点集群                       │
          └─────────────────┬───────────────────────────┘
                            │
          ┌─────────────────┼───────────────────────────┐
          │         分布式存储集群 (RocksDB)             │
          │  • 数据分片: 一致性哈希                      │
          │  • 数据复制: 3副本                          │
          │  • 备份策略: 每日全量+实时增量               │
          └─────────────────────────────────────────────┘
```

## 监控架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           系统监控架构                                       │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Prometheus     │    │   Grafana       │    │   Alertmanager  │
│   (指标收集)     │    │   (可视化)       │    │   (告警管理)    │
└─────────┬───────┘    └─────────┬───────┘    └─────────┬───────┘
          │                      │                      │
          └──────────────────────┼──────────────────────┘
                                 │
          ┌──────────────────────┼──────────────────────┐
          │          监控数据导出器 (Metrics Exporter)   │
          │  • Redis TCP服务器指标                     │
          │  • 业务实例健康指标                        │
          │  • TSDB存储性能指标                        │
          └─────────────────┬───────────────────────────┘
                            │
          ┌─────────────────┼───────────────────────────┐
          │          系统组件监控点                      │
          │  • Redis TCP服务器: 连接数、QPS、延迟       │
          │  • 业务实例: 健康状态、性能指标             │
          │  • TSDB存储: 写入量、查询量、存储空间       │
          └─────────────────────────────────────────────┘
```

## 性能指标

### Redis TCP服务器性能
- **连接数**：支持10,000+并发连接
- **QPS**：78,064.01次/秒（批量查询）
- **延迟**：P99 < 1ms
- **批量处理**：支持1,000条/批的批量操作

### TSDB存储性能
- **写入性能**：1,800,000笔/秒
- **查询性能**：62,328.60 QPS
- **压缩率**：4:1压缩比
- **存储效率**：74字节/记录

### 业务实例性能
- **实例启动时间**：< 2秒
- **故障切换时间**：< 5秒
- **配置热更新**：支持运行时配置更新

## 容错机制

### 1. 多层故障检测
```
客户端 → Redis TCP服务器 → 统一数据访问层 → 业务路由管理器 → 业务实例 → TSDB存储
    ↓           ↓               ↓               ↓             ↓           ↓
连接超时   协议错误检测     路由失败检测     健康检查失败   实例故障检测  存储故障检测
```

### 2. 自动故障切换
- **Redis TCP服务器**：多节点集群，自动负载均衡
- **业务实例**：健康检查+自动重启
- **存储层**：数据复制+自动故障转移

### 3. 数据一致性保障
- **写入确认**：所有写入操作返回确认
- **数据复制**：多副本数据同步
- **事务支持**：支持批量操作的事务性

## 扩展性设计

### 1. 水平扩展
- **Redis TCP服务器**：支持无限水平扩展
- **业务实例**：按业务类型独立扩展
- **存储层**：支持数据分片和负载均衡

### 2. 垂直扩展
- **性能优化**：支持配置调优和硬件升级
- **功能扩展**：模块化设计，易于功能扩展
- **协议扩展**：支持自定义命令和协议扩展

## 总结

TSDB+Redis系统架构通过多层设计实现了：

1. **高性能**：基于libevent的事件驱动和RocksDB的高效存储
2. **高可用**：多层故障检测和自动切换机制
3. **易扩展**：模块化设计和水平扩展能力
4. **业务隔离**：7个业务实例的完全数据隔离
5. **标准兼容**：完全兼容Redis协议，支持现有生态

该架构特别适合需要高性能时序数据存储和标准Redis接口访问的金融、IOT等应用场景。