# Redis集群服务器架构图

## 整体架构概览

```
┌─────────────────────────────────────────────────────────────────┐
│                    Redis集群服务器架构                         │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   客户端应用     │    │   客户端应用     │    │   客户端应用     │
│  (DEALER Socket) │    │  (DEALER Socket) │    │  (DEALER Socket) │
└─────────┬───────┘    └─────────┬───────┘    └─────────┬───────┘
          │                      │                      │
          └──────────────────────┼──────────────────────┘
                                 │
          ┌──────────────────────┼──────────────────────┐
          │          Redis集群服务器节点 1               │
          │ ┌─────────────────────────────────────────┐ │
          │ │           ROUTER Socket                │ │
          │ │          监听: 127.0.0.1:6379         │ │
          │ └─────────────────────────────────────────┘ │
          │ ┌─────────────────────────────────────────┐ │
          │ │           DEALER Socket                │ │
          │ │  集群通信: 127.0.0.1:5555 (绑定)       │ │
          │ │  连接其他节点集群端口                  │ │
          │ └─────────────────────────────────────────┘ │
          │ ┌─────────────────────────────────────────┐ │
          │ │          事件循环处理器                │ │
          │ │  • 处理客户端请求                     │ │
          │ │  • 集群消息路由                      │ │
          │ │  • 心跳检测                         │ │
          │ └─────────────────────────────────────────┘ │
          │ ┌─────────────────────────────────────────┐ │
          │ │          TSDB存储引擎                   │ │
          │ │  • RocksDB数据存储                    │ │
          │ │  • 时间序列数据处理                   │ │
          │ └─────────────────────────────────────────┘ │
          └─────────────────┬───────────────────────────┘
                            │
          ┌─────────────────┼───────────────────────────┐
          │          ZeroMQ集群网络                     │
          │          (TCP连接网格)                      │
          └─────────────────┬───────────────────────────┘
                            │
          ┌─────────────────┼───────────────────────────┐
          │          Redis集群服务器节点 2               │
          │ ┌─────────────────────────────────────────┐ │
          │ │           ROUTER Socket                │ │
          │ │          监听: 127.0.0.1:6380         │ │
          │ └─────────────────────────────────────────┘ │
          │ ┌─────────────────────────────────────────┐ │
          │ │           DEALER Socket                │ │
          │ │  集群通信: 127.0.0.1:5556 (绑定)       │ │
          │ │  连接其他节点集群端口                  │ │
          │ └─────────────────────────────────────────┘ │
          └─────────────────┬───────────────────────────┘
                            │
          ┌─────────────────┼───────────────────────────┐
          │          Redis集群服务器节点 N               │
          │ ┌─────────────────────────────────────────┐ │
          │ │           ROUTER Socket                │ │
          │ │          监听: 127.0.0.1:63XX          │ │
          │ └─────────────────────────────────────────┘ │
          │ ┌─────────────────────────────────────────┐ │
          │ │           DEALER Socket                │ │
          │ │  集群通信: 127.0.0.1:55XX (绑定)       │ │
          │ │  连接其他节点集群端口                  │ │
          │ └─────────────────────────────────────────┘ │
          └─────────────────────────────────────────────┘
```

## 核心组件详解

### 1. ROUTER Socket (客户端通信)
- **端口**: 6379 (标准Redis端口)
- **协议**: ZeroMQ ROUTER/DEALER模式
- **消息格式**: [身份标识, 空帧, 数据]
- **功能**: 处理所有客户端连接和Redis协议请求

### 2. DEALER Socket (集群通信)
- **端口**: 5555 (集群内部通信端口)
- **协议**: ZeroMQ DEALER/DEALER模式
- **消息格式**: JSON格式的集群消息
- **功能**: 节点间数据同步、心跳检测、集群管理

### 3. 事件循环处理器
- **轮询机制**: ZeroMQ Poller (100ms超时)
- **处理逻辑**: 同时监听ROUTER和DEALER socket事件
- **定时任务**: 
  - 每10秒发送心跳消息
  - 每30秒清理空闲连接
  - 持续处理网络事件

### 4. TSDB存储引擎
- **存储后端**: RocksDB
- **数据格式**: 时间序列数据
- **功能**: 股票行情数据存储和查询

## 消息流详解

### 客户端请求处理流程
```
1. 客户端连接 → ROUTER Socket (6379端口)
2. 发送消息格式: [client_id, "", "*1\r\n$4\r\nPING\r\n"]
3. 服务器解析Redis协议: PING命令
4. 执行命令处理逻辑
5. 返回响应格式: [client_id, "", "+PONG\r\n"]
6. 客户端接收响应
```

### 集群通信流程
```
1. 节点启动 → 发送JOIN消息到集群网络
2. 其他节点响应WELCOME消息
3. 定期发送HEARTBEAT心跳消息
4. 数据同步: 通过DATA_SYNC消息
5. 节点离开: 发送LEAVE消息
```

## 集群管理功能

### 节点状态管理
- **UNKNOWN**: 未知状态
- **CONNECTING**: 连接中
- **CONNECTED**: 已连接
- **DISCONNECTED**: 断开连接
- **ERROR**: 错误状态

### 集群消息类型
- **HEARTBEAT**: 心跳检测
- **DATA_SYNC**: 数据同步
- **DATA_REQUEST**: 数据请求
- **CLUSTER_INFO**: 集群信息
- **NODE_JOIN**: 节点加入
- **NODE_LEAVE**: 节点离开
- **LEADER_ELECTION**: 领导者选举
- **CONFIG_UPDATE**: 配置更新

## 性能统计

服务器维护详细的性能统计信息：
- 总连接数
- 当前连接数
- 总命令数
- 错误数
- 收发字节数
- 集群消息收发统计

## 容错机制

### 连接管理
- 5分钟空闲连接自动清理
- 连接异常自动重连
- 心跳检测确保节点存活

### 错误处理
- Redis协议解析错误处理
- 集群通信异常处理
- TSDB存储错误处理

## 部署配置

### 单节点配置
```lua
{
    port = 6379,           -- Redis服务端口
    bind_addr = "127.0.0.1", -- 绑定地址
    node_id = "redis_node_1", -- 节点标识
    cluster_port = 5555,    -- 集群通信端口
    cluster_nodes = {}      -- 其他集群节点地址
}
```

### 多节点集群配置
```lua
-- 节点1配置
{
    port = 6379,
    node_id = "node_1",
    cluster_port = 5555,
    cluster_nodes = {"127.0.0.1:5556", "127.0.0.1:5557"}
}

-- 节点2配置
{
    port = 6380,
    node_id = "node_2",
    cluster_port = 5556,
    cluster_nodes = {"127.0.0.1:5555", "127.0.0.1:5557"}
}
```

## 测试验证

### 连接测试
```bash
# 使用nc测试基础连接
echo "*1\r\n$4\r\nPING\r\n" | nc -w 2 127.0.0.1 6379

# 使用ZMQ客户端测试
luajit tests/test_zmq_redis.lua
```

### 集群测试
```bash
# 启动多个节点
make redis-server PORT=6379 CLUSTER_PORT=5555
make redis-server PORT=6380 CLUSTER_PORT=5556

# 测试集群通信
make redis-test-full
```

这个架构提供了高性能的分布式时间序列数据库服务，兼容Redis协议的同时支持集群扩展。