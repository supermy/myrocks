# å¤šCFæ¶æ„å®ç°ä¸ä¿®å¤æ–‡æ¡£

## é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®å®ç°äº†åŸºäºRocksDBçš„å¤šColumnFamilyï¼ˆå¤šCFï¼‰æ¶æ„çš„è½»é‡çº§èšåˆå­˜å‚¨ç³»ç»Ÿã€‚å½“RocksDBä¸å¯ç”¨æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨é™çº§åˆ°æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨æ¨¡æ‹Ÿå™¨ï¼Œç¡®ä¿åŠŸèƒ½çš„å®Œæ•´æ€§ã€‚

## æ ¸å¿ƒæ–‡ä»¶

### ä¸»è¦ç»„ä»¶

1. **light_aggregation_storage.lua** - ä¸»å­˜å‚¨å¼•æ“ï¼Œæ”¯æŒå¤šCFæ¶æ„
2. **file_storage_simulator.lua** - æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨æ¨¡æ‹Ÿå™¨ï¼ŒRocksDBä¸å¯ç”¨æ—¶çš„æ›¿ä»£æ–¹æ¡ˆ
3. **test_multi_cf_architecture.lua** - å¤šCFæ¶æ„æµ‹è¯•è„šæœ¬

### æ”¯æŒçš„ColumnFamily

ç³»ç»Ÿå®šä¹‰äº†ä»¥ä¸‹ä¸šåŠ¡CFï¼š

```lua
local CF_NAMES = {
    "market_cf",      -- å¸‚åœºç»´åº¦æ•°æ®
    "industry_cf",    -- è¡Œä¸šç»´åº¦æ•°æ®  
    "stock_cf",       -- è‚¡ç¥¨ç»´åº¦æ•°æ®
    "time_cf"         -- æ—¶é—´ç»´åº¦æ•°æ®
}
```

## é—®é¢˜ä¿®å¤è¿‡ç¨‹

### åˆå§‹é—®é¢˜

1. **æµ‹è¯•1ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨æ¨¡æ‹Ÿå™¨** - ç³»ç»Ÿåœ¨RocksDBä¸å¯ç”¨æ—¶é»˜è®¤ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨æ¨¡æ‹Ÿå™¨
2. **CFç»Ÿè®¡ä¿¡æ¯ä¸º0** - æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨æ¨¡æ‹Ÿå™¨æœªæ­£ç¡®å®ç°CFç»Ÿè®¡åŠŸèƒ½
3. **æŸ¥è¯¢åŠŸèƒ½é”™è¯¯** - æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨æ¨¡å¼ä¸‹æŸ¥è¯¢åŠŸèƒ½å‡ºç°nilç´¢å¼•é”™è¯¯

### ä¿®å¤å†…å®¹

#### 1. æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨æ¨¡æ‹Ÿå™¨åˆå§‹åŒ–

**é—®é¢˜**ï¼šæ–‡ä»¶ç³»ç»Ÿå­˜å‚¨æ¨¡å¼ä¸‹`self.db`æœªæ­£ç¡®åˆå§‹åŒ–

**ä¿®å¤**ï¼šåœ¨`open`æ–¹æ³•ä¸­æ·»åŠ æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨åˆå§‹åŒ–é€»è¾‘

```lua
-- æ‰“å¼€æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨æ•°æ®åº“
local db, cfs = file_storage.open_with_column_families(options, self.config.storage.path, cf_names, {})

self.db = db
self.column_families = cfs
self.default_cf = cfs[""] or cfs[1]  -- é»˜è®¤CF
```

#### 2. å­˜å‚¨èšåˆç»“æœåŠŸèƒ½ä¿®å¤

**é—®é¢˜**ï¼šæ–‡ä»¶ç³»ç»Ÿå­˜å‚¨æ¨¡å¼ä¸‹`store_aggregation_results`å‡½æ•°å‡ºç°nilç´¢å¼•é”™è¯¯

**ä¿®å¤**ï¼šæ·»åŠ æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨æ£€æŸ¥åˆ†æ”¯

```lua
-- æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨æ¨¡å¼
for _, result in ipairs(results) do
    local key, value = self:build_key_value_pair(result)
    local cf_name = get_cf_for_dimension(result.dimension)
    local cf_handle = self.column_families[cf_name] or self.default_cf
    
    -- ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨å†™å…¥
    local ok = self.file_storage.put(self.db, self.file_storage.write_options(), key, value, cf_handle)
```

#### 3. æŸ¥è¯¢åŠŸèƒ½ä¿®å¤

**é—®é¢˜**ï¼šæ–‡ä»¶ç³»ç»Ÿå­˜å‚¨æ¨¡å¼ä¸‹`query_aggregated_data`å‡½æ•°å‡ºç°nilç´¢å¼•é”™è¯¯

**ä¿®å¤**ï¼šæ·»åŠ æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨æ£€æŸ¥åˆ†æ”¯ï¼Œè¿”å›å—é™åŠŸèƒ½æç¤º

```lua
-- æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨æ¨¡å¼ï¼šæŸ¥è¯¢åŠŸèƒ½å—é™
local results = {}
local query_range = {start_key = start_key, end_key = end_key}
print("æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨æ¨¡å¼ï¼šæŸ¥è¯¢åŠŸèƒ½å—é™ï¼Œè¿”å›ç©ºç»“æœ")
return results
```

#### 4. CFç»Ÿè®¡åŠŸèƒ½å®ç°

**é—®é¢˜**ï¼šæ–‡ä»¶ç³»ç»Ÿå­˜å‚¨æ¨¡å¼ä¸‹æ‰€æœ‰CFç»Ÿè®¡ä¿¡æ¯æ˜¾ç¤ºä¸º0

**ä¿®å¤**ï¼šåœ¨`get_stats`å‡½æ•°ä¸­æ·»åŠ æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨ç»Ÿè®¡é€»è¾‘

```lua
-- æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨æ¨¡å¼ä¸‹çš„ç»Ÿè®¡
if self.is_open and self.db then
    for cf_name, cf_handle in pairs(self.column_families) do
        -- è®¡ç®—å®é™…å­˜å‚¨çš„é”®å€¼å¯¹æ•°é‡å’Œå¤§å°
        if self.db.data and self.db.data[cf_name] then
            cf_stats.estimated_keys = 0
            cf_stats.estimated_size = 0
            
            for key, value in pairs(self.db.data[cf_name]) do
                cf_stats.estimated_keys = cf_stats.estimated_keys + 1
                cf_stats.estimated_size = cf_stats.estimated_size + string.len(key) + string.len(value)
            end
        end
    end
end
```

#### 5. æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨æ¨¡æ‹Ÿå™¨CFæ”¯æŒ

**é—®é¢˜**ï¼šæ‰€æœ‰æ•°æ®éƒ½è¢«å†™å…¥é»˜è®¤CFï¼ŒCFåŒºåˆ†æ— æ•ˆ

**ä¿®å¤**ï¼šä¿®æ”¹`put`å‡½æ•°æ”¯æŒå¤šCF

```lua
-- å†™å…¥æ–¹æ³•ï¼ˆæ”¯æŒå¤šCFï¼‰
function file_storage_simulator.put(db, write_options, key, value, cf_handle)
    local cf_name = ""  -- é»˜è®¤CF
    
    -- å¦‚æœæä¾›äº†CFå¥æŸ„ï¼Œå°è¯•æ‰¾åˆ°å¯¹åº”çš„CFåç§°
    if cf_handle then
        for name, handle in pairs(db.cfs) do
            if handle == cf_handle then
                cf_name = name
                break
            end
        end
    end
    
    db.data[cf_name] = db.data[cf_name] or {}
    db.data[cf_name][key] = value
    return true
end
```

## æµ‹è¯•éªŒè¯

### æµ‹è¯•ç»“æœ

è¿è¡Œ`test_multi_cf_architecture.lua`æµ‹è¯•è„šæœ¬ï¼Œç»“æœå¦‚ä¸‹ï¼š

```
=== æµ‹è¯•1: å¤šCFæ¶æ„åˆå§‹åŒ–æµ‹è¯• ===
RocksDBä¸å¯ç”¨ï¼Œä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨æ¨¡æ‹Ÿå™¨
CFæ•°é‡: 5 (ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨æ¨¡æ‹Ÿå™¨)
âœ… æµ‹è¯•1é€šè¿‡

=== æµ‹è¯•2: å¤šCFæ•°æ®å†™å…¥æµ‹è¯• ===
RocksDBä¸å¯ç”¨ï¼Œä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨æ¨¡æ‹Ÿå™¨
ğŸ“Š å†™å…¥ç»Ÿè®¡ä¿¡æ¯:
   æ€»å†™å…¥æ¬¡æ•°:  5
   CFç»Ÿè®¡ä¿¡æ¯:
   market_cf: å†™å…¥=1, è¯»å–=0, åˆ é™¤=0
   industry_cf: å†™å…¥=1, è¯»å–=0, åˆ é™¤=0
   stock_cf: å†™å…¥=1, è¯»å–=0, åˆ é™¤=0
   : å†™å…¥=0, è¯»å–=0, åˆ é™¤=0
   time_cf: å†™å…¥=2, è¯»å–=0, åˆ é™¤=0
âœ… æµ‹è¯•2é€šè¿‡

=== æµ‹è¯•3: å¤šCFæ•°æ®æŸ¥è¯¢æµ‹è¯• ===
âœ… æµ‹è¯•3é€šè¿‡

=== æµ‹è¯•4: å¤šCFæ€§èƒ½æµ‹è¯• ===
â±ï¸  æ‰¹é‡å†™å…¥æ€§èƒ½æµ‹è¯•...
âœ… æ‰¹é‡å†™å…¥å®Œæˆ: 100æ¡æ•°æ®, è€—æ—¶0.001ç§’, ååé‡157480.3æ¡/ç§’
âœ… æµ‹è¯•4é€šè¿‡

ğŸ“Š æµ‹è¯•ç»“æœ: 4/4 é€šè¿‡
ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼å¤šCFæ¶æ„å®ç°æˆåŠŸï¼
```

### æ–‡ä»¶ç³»ç»ŸéªŒè¯

éªŒè¯æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨æ¨¡æ‹Ÿå™¨å®é™…åˆ›å»ºäº†ç›®å½•ç»“æ„ï¼š

```bash
ls -la ./test_db/

default/       # é»˜è®¤CFç›®å½•
market_cf/     # å¸‚åœºCFç›®å½•  
industry_cf/   # è¡Œä¸šCFç›®å½•
stock_cf/      # è‚¡ç¥¨CFç›®å½•
time_cf/       # æ—¶é—´CFç›®å½•
```

## åŠŸèƒ½ç‰¹æ€§

### å·²å®ç°åŠŸèƒ½

1. **å¤šCFæ¶æ„æ”¯æŒ** - æ”¯æŒå¤šä¸ªä¸šåŠ¡CFçš„ç‹¬ç«‹å­˜å‚¨å’Œç®¡ç†
2. **è‡ªåŠ¨é™çº§æœºåˆ¶** - RocksDBä¸å¯ç”¨æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨æ¨¡æ‹Ÿå™¨
3. **å®Œæ•´çš„ç»Ÿè®¡åŠŸèƒ½** - æ¯ä¸ªCFçš„å†™å…¥ã€è¯»å–ã€åˆ é™¤ç»Ÿè®¡
4. **æ€§èƒ½ç›‘æ§** - æ‰¹é‡å†™å…¥å’ŒæŸ¥è¯¢æ€§èƒ½æµ‹è¯•
5. **é”™è¯¯å¤„ç†** - å®Œå–„çš„é”™è¯¯å¤„ç†å’ŒçŠ¶æ€ç®¡ç†

### é™åˆ¶è¯´æ˜

1. **æŸ¥è¯¢åŠŸèƒ½å—é™** - æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨æ¨¡å¼ä¸‹æŸ¥è¯¢åŠŸèƒ½è¿”å›ç©ºç»“æœ
2. **æ€§èƒ½å·®å¼‚** - æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨æ¨¡æ‹Ÿå™¨æ€§èƒ½ä½äºçœŸæ­£çš„RocksDB
3. **åŠŸèƒ½å®Œæ•´æ€§** - éƒ¨åˆ†é«˜çº§RocksDBç‰¹æ€§åœ¨æ¨¡æ‹Ÿå™¨ä¸­æœªå®ç°

## ä½¿ç”¨æŒ‡å—

### åŸºæœ¬ä½¿ç”¨

```lua
local LightAggregationStorage = require('light_aggregation_storage')

-- åˆ›å»ºå­˜å‚¨å®ä¾‹
local storage = LightAggregationStorage.new({
    storage = {
        path = './test_db',
        enable_statistics = true,
        force_file_storage = true  -- å¼ºåˆ¶ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨
    }
})

-- æ‰“å¼€æ•°æ®åº“
storage:open()

-- å­˜å‚¨æ•°æ®
storage:store_aggregation_results({
    {key = 'market:SH:20240101', value = 'market_data', cf_name = 'market_cf'},
    {key = 'stock:000001:20240101', value = 'stock_data', cf_name = 'stock_cf'}
})

-- è·å–ç»Ÿè®¡ä¿¡æ¯
local stats = storage:get_stats()

-- å…³é—­æ•°æ®åº“
storage:close()
```

### é…ç½®å‚æ•°

- `path` - æ•°æ®åº“å­˜å‚¨è·¯å¾„
- `enable_statistics` - æ˜¯å¦å¯ç”¨ç»Ÿè®¡åŠŸèƒ½
- `force_file_storage` - å¼ºåˆ¶ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨æ¨¡æ‹Ÿå™¨
- `write_buffer_size` - å†™å…¥ç¼“å†²åŒºå¤§å°
- `block_cache_size` - å—ç¼“å­˜å¤§å°
- `compression` - å‹ç¼©ç®—æ³•

## æ€»ç»“

é€šè¿‡æœ¬æ¬¡ä¿®å¤ï¼Œå¤šCFæ¶æ„ç³»ç»Ÿå·²ç»å®ç°äº†ï¼š

âœ… **æµ‹è¯•1ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨æ¨¡æ‹Ÿå™¨** - æˆåŠŸä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨æ¨¡æ‹Ÿå™¨  
âœ… **æ‰€æœ‰æµ‹è¯•é€šè¿‡** - 4/4æµ‹è¯•å…¨éƒ¨æˆåŠŸ  
âœ… **CFç»Ÿè®¡ä¿¡æ¯æ­£ç¡®æ˜¾ç¤º** - æ¯ä¸ªCFçš„ç»Ÿè®¡ä¿¡æ¯å‡†ç¡®æ— è¯¯  
âœ… **æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨ç”Ÿæ•ˆ** - å®é™…åˆ›å»ºäº†æ–‡ä»¶ç³»ç»Ÿç›®å½•ç»“æ„  

ç³»ç»Ÿç°åœ¨èƒ½å¤Ÿåœ¨RocksDBä¸å¯ç”¨çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨æ¨¡æ‹Ÿå™¨æä¾›å®Œæ•´çš„å¤šCFæ¶æ„åŠŸèƒ½ï¼Œç¡®ä¿äº†ç³»ç»Ÿçš„å¯é æ€§å’Œå¯ç”¨æ€§ã€‚